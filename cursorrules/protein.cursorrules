# Protein Module Rules (`metainformant.protein`)

## Purpose
Protein sequence and structure analysis, database integration, and 3D structure handling.

## Dependencies
- **Required**: `core`
- **Optional**: `biopython`, external databases (UniProt, InterPro, AlphaFold, PDB)

## Source Structure
```
src/metainformant/protein/
├── orchestration.py
├── database/
│   ├── interpro.py, uniprot.py
├── sequence/
│   ├── alignment.py, proteomes.py, sequences.py
├── structure/
│   ├── alphafold.py, analysis.py, contacts.py, general.py, io.py, pdb.py, secondary.py
└── visualization/
    └── general.py
```

## Package Management
- **ALWAYS use `uv`** for all Python package management and environment operations
- Install optional dependencies: `uv add biopython`
- Use `uv run` to execute commands: `uv run pytest`, `uv run metainformant protein --help`
- **NEVER use `pip` directly**

## Key Submodules

### Sequences (`sequences`)
- Protein sequence operations
- Sequence validation
- Amino acid composition

### Alignment (`alignment`)
- Protein sequence alignment
- Scoring matrices (BLOSUM, PAM)
- Gap penalties

### Structure (`structure`)
- 3D structure analysis
- Structure validation
- Secondary structure prediction

### Structure I/O (`structure_io`)
- PDB/mmCIF file reading and writing
- Structure format conversion

**Patterns**:
```python
from metainformant.protein.structure import io as structure_io

structure = structure_io.read_pdb("data/structure.pdb")
structure_io.write_pdb(structure, "output/protein/structure.pdb")
```

### UniProt (`uniprot`)
- UniProt database integration
- Protein record retrieval
- Annotation extraction

### InterPro (`interpro`)
- InterPro domain annotation
- Functional domain prediction
- Domain architecture analysis

### AlphaFold (`alphafold`)
- AlphaFold structure retrieval
- Structure quality assessment
- Confidence score analysis

### PDB (`pdb`)
- PDB database integration
- Structure download utilities
- Metadata extraction

### Proteomes (`proteomes`)
- Proteome retrieval and management
- Proteome database integration
- Large-scale proteome analysis

### Contacts (`contacts`)
- Protein contact analysis
- Residue-residue contacts
- Contact map generation

### Secondary Structure (`secondary`)
- Secondary structure prediction
- Structure element identification
- Secondary structure analysis

### Structure Analysis (`structure_analysis`)
- Advanced structure analysis
- Structural feature extraction
- Structure comparison utilities

## Patterns

### I/O Operations
- **CRITICAL**: Always use `metainformant.core.io` for JSON/CSV/TSV operations
- Never use direct `import json` or `import csv`

**Pattern**:
```python
from metainformant.core import io

# Save results
io.dump_json(results, "output/protein/annotations/results.json")
io.write_csv(df, "output/protein/alignments/alignment.csv")
```

### Path Handling
- Always use `metainformant.core.paths` utilities for path operations
- Always resolve and validate paths using `paths.expand_and_resolve()` and `paths.is_within()`

**Pattern**:
```python
from metainformant.core import paths

# Expand and resolve paths
structure_path = paths.expand_and_resolve("output/protein/structures/")
```

### Type Hints
- Comprehensive type hints throughout
- Use `from __future__ import annotations` for forward references
- Union types: `str | Path | None`

### Defensive Imports
- Use defensive imports for optional database libraries
- Handle missing database connections gracefully

**Pattern**:
```python
try:
    from Bio import PDB
    PDB_AVAILABLE = True
except ImportError:
    PDB_AVAILABLE = False

def download_structure(pdb_id):
    if not PDB_AVAILABLE:
        raise ImportError("Bio.PDB required for structure download")
    # Download structure
```

### Structure Formats
- Support standard formats: PDB, mmCIF
- Prefer mmCIF for new structures (more complete)
- Validate structure files before processing

### Output Paths
- Structures: `output/protein/structures/`
- Alignments: `output/protein/alignments/`
- Annotations: `output/protein/annotations/`
- Proteomes: `output/protein/proteomes/`
- Contacts: `output/protein/contacts/`
- Secondary structure: `output/protein/secondary/`

### Error Handling
- Gracefully handle missing database connections
- Provide clear error messages for missing files
- Validate structure integrity

## Configuration

- No module-specific config (uses core config)
- Output paths default to `output/protein/`
- Environment prefix: `PROT_` (e.g., `PROT_THREADS`, `PROT_WORK_DIR`)

## Integration

- **Used by**: `networks` (PPI networks), `multiomics` (proteomics integration)
- **External**: UniProt, InterPro, AlphaFold, PDB databases

## Reference

See main `.cursorrules` for:
- Common directory structure and path handling
- Configuration patterns with env overrides
- Testing policy (NO_MOCKING_POLICY)
- Import patterns and code style
- Documentation guidelines

## Testing

- **STRICTLY NO MOCKING**: Test real implementations only (see main `.cursorrules` NO_MOCKING_POLICY)
- Skip tests if optional dependencies unavailable using `@pytest.mark.external_tool`
- Test with real PDB files from `data/`
- Write test outputs to `output/protein/test/` using `tmp_path` fixture
- No mocks, fakes, or stubs - use real file operations and database queries


