# Quality Module Rules (`metainformant.quality`)

## Purpose
Data quality assessment and control: FASTQ quality metrics, general quality metrics, and contamination detection.

## Dependencies
- **Required**: `core`, `dna.fastq`

## Key Submodules

### FASTQ (`fastq`)
- FASTQ quality metrics
- Per-base quality scores
- Read quality assessment

**Patterns**:
```python
from metainformant.quality import fastq

metrics = fastq.assess_fastq_quality(
    fastq_file="data/reads.fastq",
    output_dir="output/quality/fastq/"
)
# Returns: dict with quality metrics
```

### Metrics (`metrics`)
- General quality metrics
- Data integrity checking
- Format validation

### Contamination (`contamination`)
- Contamination detection
- Taxonomic classification
- Contaminant identification

## Patterns

### I/O Operations
- **CRITICAL**: Always use `metainformant.core.io` for JSON/CSV/TSV operations
- Never use direct `import json` or `import csv`

**Pattern**:
```python
from metainformant.core import io

# Save quality reports
io.dump_json(metrics, "output/quality/dataset/reports/qc_metrics.json")
io.write_csv(df, "output/quality/dataset/reports/quality_summary.csv")
```

### Path Handling
- Always use `metainformant.core.paths` utilities for path operations
- Always resolve and validate paths using `paths.expand_and_resolve()` and `paths.is_within()`

**Pattern**:
```python
from metainformant.core import paths

# Expand and resolve paths
output_dir = paths.expand_and_resolve("output/quality/dataset/")
```

### Type Hints
- Comprehensive type hints throughout
- Use `from __future__ import annotations` for forward references
- Union types: `str | Path | None`

### Quality Metrics
- Quality metrics should return structured dictionaries
- Include summary statistics and distributions
- Report quality thresholds and pass/fail status

### Output Paths
- Base: `output/quality/<dataset>/`
- FASTQ: `output/quality/<dataset>/fastq/`
- Reports: `output/quality/<dataset>/reports/`

## Configuration

- No module-specific config (uses core config)
- Output paths default to `output/quality/`
- Environment prefix: `QC_` (e.g., `QC_THREADS`, `QC_WORK_DIR`)

## Integration

- **Used by**: `rna` (FASTQ quality control), `gwas` (variant QC)

## Reference

See main `.cursorrules` for:
- Common directory structure and path handling
- Configuration patterns with env overrides
- Testing policy (NO_MOCKING_POLICY)
- Import patterns and code style
- Documentation guidelines

## Testing

- **STRICTLY NO MOCKING**: Test real implementations only (see main `.cursorrules` NO_MOCKING_POLICY)
- Test with real FASTQ files from `data/`
- Write test outputs to `output/quality/test/` using `tmp_path` fixture
- Test contamination detection with known samples
- No mocks, fakes, or stubs - use real file operations


