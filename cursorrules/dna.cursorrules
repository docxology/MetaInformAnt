# DNA Module Rules (`metainformant.dna`)

## Purpose
DNA sequence analysis, genomics, population genetics, and variant calling.

## Dependencies
- **Required**: `core`
- **Optional**: `biopython`, `ncbi-datasets-pylib`, `pysam`

## Source Structure
```
src/metainformant/dna/
├── alignment/
│   ├── distances.py, msa.py, pairwise.py
├── expression/
│   ├── codon.py, transcription.py, translation.py
├── external/
│   ├── entrez.py, genomes.py, ncbi.py
├── integration/
│   └── rna.py
├── io/
│   ├── fasta.py, fastq.py
├── phylogeny/
│   └── tree.py
├── population/
│   ├── analysis.py, core.py, visualization.py
├── sequence/
│   ├── composition.py, consensus.py, core.py, kmer.py, motifs.py, restriction.py
└── variation/
    ├── mutations.py, variants.py
```

## Package Management
- **ALWAYS use `uv`** for all Python package management and environment operations
- Install optional dependencies: `uv add biopython`, `uv add ncbi-datasets-pylib`, `uv add pysam`
- Use `uv run` to execute commands: `uv run pytest`, `uv run python scripts/dna/example.py`
- **NEVER use `pip` directly**

## Key Submodules

### Sequences (`sequences`)
- FASTA/FASTQ reading and writing
- Basic sequence operations
- Sequence validation

**Patterns**:
```python
from metainformant.dna.sequence import core as sequences

seqs = sequences.read_fasta("data/sequences.fasta")
for seq_id, sequence in seqs:
    # Process sequence
    pass
```

### Alignment (`alignment`)
- Pairwise sequence alignment
- Global and local alignment algorithms
- Needleman-Wunsch and Smith-Waterman
- Alignment scoring

### Multiple Sequence Alignment (`msa`)
- Progressive alignment algorithm
- External tool integration (MUSCLE, MAFFT, ClustalW)
- Consensus generation from alignments
- Gap handling and optimization

### Phylogeny (`phylogeny`)
- Phylogenetic tree construction (Neighbor-Joining)
- Tree format: Newick
- Output to `output/dna/phylogeny/`

**Patterns**:
```python
from metainformant.dna.phylogeny import tree

tree_result = tree.neighbor_joining_tree(sequences)
# Returns Newick format string or tree object
```

### Population (`population`)
- Population genetics statistics
- π (pi), Tajima's D, Fst
- Returns dictionaries with named statistics

**Patterns**:
```python
from metainformant.dna.population import core as population

stats = population.calculate_pi(sequences)
# Returns: {"pi": 0.001, "segregating_sites": 42, ...}
```

### Population Analysis (`population_analysis`)
- Advanced population genetics analysis
- Extended population statistics
- Complex population genetic calculations

### Population Visualization (`population_viz`)
- Population genetics visualization
- Statistical plot generation
- Population structure visualization

### Variants (`variants`)
- Variant calling and analysis
- VCF file support
- Variant filtering and quality control

### Genomes (`genomes`)
- Genome data management
- Genome accession validation
- Genome metadata handling

### NCBI (`ncbi`)
- NCBI Datasets API integration
- Genome download utilities
- API integration with error handling

**Patterns**:
```python
from metainformant.dna.external import ncbi, genomes

# Validate accession
accession = genomes.validate_accession("GCF_000001405.40")

# Download genome
genome_data = ncbi.download_genome(
    species="Homo sapiens",
    output_dir="output/dna/genomes/"
)
```

### Entrez (`entrez`)
- Entrez query construction and execution
- Sequence search and retrieval
- Database query utilities

### FastQ (`fastq`)
- FASTQ-specific processing
- Quality score analysis
- Read filtering

### Motifs (`motifs`)
- Pattern discovery
- Position Weight Matrix (PWM) analysis
- Motif enrichment

### Restriction (`restriction`)
- Restriction enzyme analysis
- Cutting site prediction
- Fragment size calculation

### Transcription (`transcription`)
- DNA to RNA transcription
- Transcription utilities
- RNA sequence generation

### Translation (`translation`)
- RNA to protein translation
- Genetic code handling
- Protein sequence generation

### Mutations (`mutations`)
- Mutation detection and analysis
- Mutation type classification
- Mutation spectrum analysis
- Mutation rate estimation

### Codon (`codon`)
- Codon usage analysis
- Codon frequency calculations
- Genetic code utilities

### Composition (`composition`)
- Sequence composition analysis
- GC content calculation
- Dinucleotide and trinucleotide frequencies
- Compositional bias detection

### Consensus (`consensus`)
- Consensus sequence generation
- Multiple sequence consensus
- Consensus quality scoring
- Ambiguity code handling

### Distances (`distances`)
- Evolutionary distance estimation
- Jukes-Cantor distance
- Kimura 2-parameter distance
- Tamura-Nei distance
- Distance matrix construction

### RNA Integration (`rna_integration`)
- Integration with RNA module
- Cross-domain analysis utilities

## Patterns

### I/O Operations
- **CRITICAL**: Always use `metainformant.core.io` for JSON/CSV/TSV operations
- Never use direct `import json` or `import csv`

**Pattern**:
```python
from metainformant.core import io

# Save results
io.dump_json(results, "output/dna/population/stats.json")
io.write_csv(df, "output/dna/variants/variants.csv")
```

### Lazy Imports
- Use lazy imports for optional dependencies
- Avoid import failures during unrelated commands

**Pattern**:
```python
def _lazy_import_biopython():
    try:
        from Bio import SeqIO
        return SeqIO
    except ImportError:
        return None
```

### File Path Handling
- Functions accept `Path` or `str` for file paths
- Always use `metainformant.core.paths` utilities for path operations
- Always resolve and validate paths using `paths.expand_and_resolve()` and `paths.is_within()`
- Default outputs to `output/dna/<analysis_type>/`

**Pattern**:
```python
from metainformant.core import paths
from pathlib import Path

# Expand and resolve user paths
path = paths.expand_and_resolve("~/data/file.txt")

# Security check before using user-provided paths
if paths.is_within(user_path, base_dir):
    # Safe to use
    pass
```

### Type Hints
- Comprehensive type hints throughout
- Use `from __future__ import annotations` for forward references
- Union types: `str | Path | None`

### Return Formats
- Population genetics stats: dictionaries with named keys
- Phylogenetic trees: Newick format strings
- Sequence data: iterators or lists of (id, sequence) tuples

### Error Handling
- Handle missing optional dependencies gracefully
- Provide clear error messages for missing data files
- Validate input sequences before processing

## Configuration

- No module-specific config (uses core config)
- Genome data paths can be specified via config
- Output paths default to `output/dna/`
- Environment prefix: `DNA_` (e.g., `DNA_THREADS`, `DNA_WORK_DIR`)

## Output Paths

- Phylogenetic trees: `output/dna/phylogeny/`
- Population genetics: `output/dna/population/`
- Variants: `output/dna/variants/`
- Genomes: `output/dna/genomes/`
- Alignments: `output/dna/alignments/`
- Multiple alignments: `output/dna/msa/`
- Mutations: `output/dna/mutations/`
- Composition: `output/dna/composition/`
- Consensus: `output/dna/consensus/`
- Distances: `output/dna/distances/`

## Integration

- **Used by**: `gwas` (variants, population genetics), `rna` (genomic coordinates), `information` (sequence analysis)
- **Integrates with**: `visualization` (phylogenetic trees), `math.popgen` (theoretical models)

## Reference

See main `.cursorrules` for:
- Common directory structure and path handling
- Configuration patterns with env overrides
- Testing policy (NO_MOCKING_POLICY)
- Import patterns and code style
- Documentation guidelines

## Testing

- **STRICTLY NO MOCKING**: Test real implementations only (see main `.cursorrules` NO_MOCKING_POLICY)
- Test with real FASTA/FASTQ files from `data/`
- Optional dependency tests should skip gracefully with `@pytest.mark.external_tool`
- Write test outputs to `output/dna/test/` using `tmp_path` fixture
- No mocks, fakes, or stubs - use real file operations


