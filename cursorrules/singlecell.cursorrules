# Single-Cell Module Rules (`metainformant.singlecell`)

## Purpose
Single-cell transcriptomic analysis: quality control, normalization, dimensionality reduction, clustering, and trajectory analysis.

## Dependencies
- **Required**: `core`, `rna` (expression data), `ml.dimensionality`
- **Optional**: `scanpy`, `anndata`

## Key Submodules

### Preprocessing
- Quality control metrics
- Cell and gene filtering
- Normalization (log-normalization, scaling)

### Dimensionality
- Principal Component Analysis (PCA)
- t-SNE
- UMAP

**Patterns**:
```python
from metainformant.singlecell import dimensionality
from metainformant.ml.dimensionality import pca

# Use shared dimensionality reduction
pca_result = pca(expression_matrix, n_components=50)
```

### Clustering
- Leiden algorithm
- Louvain algorithm
- Community detection

### Trajectory (`trajectory`)
- Pseudotime analysis
- Trajectory inference
- Branch point detection

**Patterns**:
```python
from metainformant.singlecell import compute_pseudotime, trajectory_analysis

data = compute_pseudotime(data, root_cells=0, method="diffusion")
traj_result = trajectory_analysis(data)
```

### Integration (`integration`)
- Multi-sample batch correction
- Canonical correlation analysis (CCA)
- Mutual nearest neighbors (MNN) correction
- Harmony batch correction
- Data integration quality assessment

**Patterns**:
```python
from metainformant.singlecell import (
    integrate_datasets,
    harmony_integration,
    batch_correction
)

# Integrate multiple samples
integrated = integrate_datasets([sample1_data, sample2_data, sample3_data])

# Harmony batch correction
corrected = harmony_integration(integrated, batch_key="batch")

# Alternative: Combat batch correction
corrected = batch_correction(integrated, batch_key="batch", method="combat")
```

### Visualization (`visualization`)
- QC metrics visualization
- Dimensionality reduction plots (UMAP, t-SNE)
- Gene expression overlays
- Trajectory visualizations
- Cluster annotation plots

**Patterns**:
```python
from metainformant.singlecell import (
    plot_qc_metrics,
    plot_dimensionality_reduction,
    plot_gene_expression,
    plot_clusters
)

# Create visualizations
fig = plot_qc_metrics(data)
fig = plot_dimensionality_reduction(data, method="umap", color_by="cluster")
fig = plot_gene_expression(data, gene="GENE1")
fig = plot_clusters(data, cluster_key="cluster")
```

## Patterns

### scanpy Integration
- Use `scanpy` when available
- Fallback to scikit-learn implementations
- Handle `AnnData` objects when available

**Pattern**:
```python
try:
    import scanpy as sc
    SCANPY_AVAILABLE = True
except ImportError:
    SCANPY_AVAILABLE = False

def normalize_data(data):
    if SCANPY_AVAILABLE:
        return sc.pp.normalize_total(data)
    else:
        # Fallback implementation
        return normalize_manual(data)
```

### AnnData Objects
- Support `AnnData` format when available
- Convert to/from standard formats (pandas, numpy)
- Preserve metadata in AnnData objects

### Output Paths
- Base: `output/singlecell/<analysis>/`
- Preprocessing: `output/singlecell/<analysis>/preprocessing/`
- Clustering: `output/singlecell/<analysis>/clustering/`
- Trajectory: `output/singlecell/<analysis>/trajectory/`
- Integration: `output/singlecell/<analysis>/integration/`
- Visualizations: `output/singlecell/<analysis>/plots/`

### Dimensionality Reduction
- Use `ml.dimensionality` for shared implementations
- Support both scanpy and scikit-learn APIs
- Return consistent data structures

## Integration

- **Uses**: `rna` (expression data), `ml.dimensionality`
- **Used by**: `multiomics` (single-cell omics integration), `information` (single-cell information analysis)
- **External**: `scanpy`, `anndata` when available

## Testing

- Skip tests if scanpy/anndata unavailable
- Test with real expression matrices from `data/`
- Write test outputs to `output/singlecell/test/`


