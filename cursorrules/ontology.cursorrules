# Ontology Module Rules (`metainformant.ontology`)

## Purpose
Functional annotation and ontologies: Gene Ontology operations, OBO format parsing, and ontology querying.

## Dependencies
- **Required**: `core`
- **Optional**: External databases (Gene Ontology)

## Source Structure
```
src/metainformant/ontology/
├── go.py          # Gene Ontology operations
├── obo.py         # OBO format parsing
├── query.py       # Ontology querying
├── serialize.py   # Ontology serialization
├── types.py       # Core data structures (Term, Ontology)
└── visualization.py  # Ontology visualization
```

## Package Management
- **ALWAYS use `uv`** for all Python package management and environment operations
- Use `uv run` to execute commands: `uv run pytest`, `uv run metainformant ontology --help`
- **NEVER use `pip` directly**

## Key Submodules

### GO (`go`)
- Gene Ontology operations
- GO term enrichment
- Annotation retrieval

### OBO (`obo`)
- OBO format parsing
- Ontology file reading
- Term hierarchy navigation

### Query (`query`)
- Ontology querying
- Term search
- Relationship queries

### Serialize (`serialize`)
- Ontology serialization
- Format conversion
- Cache management

### Types (`types`)
- Core data structures for ontology representation
- `Term` class for individual ontology terms
- `Ontology` class for complete ontology objects
- Term relationships and metadata

**Patterns**:
```python
from metainformant.ontology.types import Term, Ontology

# Create a term
term = Term(
    term_id="GO:0008150",
    name="biological_process",
    namespace="biological_process",
    definition="Any process accomplished by biological systems",
    is_a_parents=["GO:0003674"],
    relationships={"part_of": ["GO:001"]},
    synonyms=["biological process", "BP"],
    xrefs=["Wikipedia:biological_process"]
)

# Create ontology and add term
onto = Ontology()
onto.add_term(term)

# Access term
if onto.has_term("GO:0008150"):
    term = onto.get_term("GO:0008150")
    namespace = onto.get_namespace("GO:0008150")
```

## Patterns

### I/O Operations
- **CRITICAL**: Always use `metainformant.core.io` for JSON/CSV/TSV operations
- Never use direct `import json` or `import csv`
- Use `io.load_json()`, `io.dump_json()` for ontology serialization

**Pattern**:
```python
from metainformant.core import io

# Save ontology
io.dump_json(ontology_data, "output/ontology/cache/ontology.json")
io.write_csv(annotations, "output/ontology/annotations/go_terms.csv")
```

### Path Handling
- Always use `metainformant.core.paths` utilities for path operations
- Always resolve and validate paths using `paths.expand_and_resolve()` and `paths.is_within()`

**Pattern**:
```python
from metainformant.core import paths

# Expand and resolve cache paths
cache_dir = paths.expand_and_resolve("output/ontology/cache/")
```

### Type Hints
- Comprehensive type hints throughout
- Use `from __future__ import annotations` for forward references
- Union types: `str | Path | None`

### Missing Ontology Files
- Handle missing ontology files gracefully
- Provide clear error messages
- Support automatic download (with user confirmation)

### Annotation Results
- Return annotation results as structured dictionaries
- Include GO terms, evidence codes, and confidence scores
- Support multiple annotation formats

### Cache Management
- Cache ontology files under `output/ontology/cache/`
- Invalidate cache when ontology versions change
- Support cache cleanup
- In-memory caching for expensive operations (ancestors/descendants)

**Patterns**:
```python
from metainformant.ontology import set_cache_enabled, set_cache_ttl, clear_cache

# Enable/disable caching
set_cache_enabled(True)

# Set cache TTL (default: 3600 seconds)
set_cache_ttl(7200)  # 2 hours

# Clear cache
clear_cache()

# Disable caching for individual calls
from metainformant.ontology.query import ancestors
ancestors_set = ancestors(onto, "GO:0008150", use_cache=False)
```

### Output Paths
- Base: `output/ontology/<analysis>/`
- Cache: `output/ontology/cache/`
- Annotations: `output/ontology/<analysis>/annotations/`

## Configuration

- No module-specific config (uses core config)
- Output paths default to `output/ontology/`
- Environment prefix: `ONT_` (e.g., `ONT_CACHE_DIR`, `ONT_DB_PATH`)

## Integration

- **Used by**: `networks` (functional enrichment), `phenotype` (trait annotation)

## Reference

See main `.cursorrules` for:
- Common directory structure and path handling
- Configuration patterns with env overrides
- Testing policy (NO_MOCKING_POLICY)
- Import patterns and code style
- Documentation guidelines

## Testing

- **STRICTLY NO MOCKING**: Test real implementations only (see main `.cursorrules` NO_MOCKING_POLICY)
- Skip tests if ontology files unavailable using `@pytest.mark.external_tool`
- Test with real GO ontology files from `data/`
- Write test outputs to `output/ontology/test/` using `tmp_path` fixture
- No mocks, fakes, or stubs - use real file operations


