============================= test session starts ==============================
platform linux -- Python 3.11.2, pytest-7.2.1, pluggy-1.0.0+repack -- /usr/bin/python3
cachedir: .pytest_cache
rootdir: /media/q/ext6/github/MetaInformAnt, configfile: pyproject.toml
plugins: anyio-3.6.2
collecting ... collected 165 items

tests/test_rna_amalgkit_cli_args.py::test_build_cli_args_basic PASSED    [  0%]
tests/test_rna_amalgkit_comprehensive.py::TestAmalgkitIntegration::test_check_cli_available PASSED [  1%]
tests/test_rna_amalgkit_comprehensive.py::TestAmalgkitIntegration::test_build_cli_args_basic PASSED [  1%]
tests/test_rna_amalgkit_comprehensive.py::TestAmalgkitIntegration::test_build_cli_args_with_lists PASSED [  2%]
tests/test_rna_amalgkit_comprehensive.py::TestAmalgkitIntegration::test_build_cli_args_with_paths PASSED [  3%]
tests/test_rna_amalgkit_comprehensive.py::TestAmalgkitIntegration::test_build_amalgkit_command PASSED [  3%]
tests/test_rna_amalgkit_comprehensive.py::TestAmalgkitIntegration::test_metadata_step_execution PASSED [  4%]
tests/test_rna_amalgkit_comprehensive.py::TestAmalgkitIntegration::test_config_step_execution PASSED [  4%]
tests/test_rna_amalgkit_comprehensive.py::TestWorkflowIntegration::test_workflow_config_loading PASSED [  5%]
tests/test_rna_amalgkit_comprehensive.py::TestWorkflowIntegration::test_workflow_planning PASSED [  6%]
tests/test_rna_amalgkit_comprehensive.py::TestWorkflowIntegration::test_workflow_execution_dry_run PASSED [  6%]
tests/test_rna_amalgkit_comprehensive.py::TestAmalgkitStepRunners::test_metadata_runner PASSED [  7%]
tests/test_rna_amalgkit_comprehensive.py::TestAmalgkitStepRunners::test_config_runner PASSED [  7%]
tests/test_rna_amalgkit_comprehensive.py::TestErrorHandling::test_invalid_config_file PASSED [  8%]
tests/test_rna_amalgkit_comprehensive.py::TestErrorHandling::test_config_validation PASSED [  9%]
tests/test_rna_amalgkit_comprehensive.py::TestErrorHandling::test_cli_unavailable_handling PASSED [  9%]
tests/test_rna_amalgkit_comprehensive.py::TestIntegrationWorkflow::test_complete_workflow_simulation PASSED [ 10%]
tests/test_rna_amalgkit_comprehensive.py::TestIntegrationWorkflow::test_workflow_with_genome_config PASSED [ 10%]
tests/test_rna_amalgkit_comprehensive.py::TestPerformanceAndRobustness::test_large_config_handling PASSED [ 11%]
tests/test_rna_amalgkit_comprehensive.py::TestPerformanceAndRobustness::test_concurrent_workflow_execution PASSED [ 12%]
tests/test_rna_amalgkit_comprehensive.py::TestPerformanceAndRobustness::test_workflow_with_filters PASSED [ 12%]
tests/test_rna_amalgkit_comprehensive.py::TestDocumentationExamples::test_workflow_example_from_docs PASSED [ 13%]
tests/test_rna_amalgkit_comprehensive.py::TestDocumentationExamples::test_cli_example_from_docs PASSED [ 13%]
tests/test_rna_amalgkit_comprehensive.py::TestAmalgkitWrapperRobustness::test_wrapper_with_missing_amalgkit PASSED [ 14%]
tests/test_rna_amalgkit_comprehensive.py::TestAmalgkitWrapperRobustness::test_wrapper_with_invalid_params PASSED [ 15%]
tests/test_rna_amalgkit_comprehensive.py::TestAmalgkitWrapperRobustness::test_step_runner_error_handling SKIPPED [ 15%]
tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitEndToEnd::test_metadata_to_config_workflow FAILED [ 16%]
tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitEndToEnd::test_cli_availability SKIPPED [ 16%]
tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitEndToEnd::test_workflow_step_sequence FAILED [ 17%]
tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitEndToEnd::test_complete_mini_workflow SKIPPED [ 18%]
tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitStepRunners::test_metadata_runner SKIPPED [ 18%]
tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitStepRunners::test_config_runner SKIPPED [ 19%]
tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitStepRunners::test_sanity_runner SKIPPED [ 20%]
tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitUtilities::test_build_cli_args_basic PASSED [ 20%]
tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitUtilities::test_build_cli_args_lists PASSED [ 21%]
tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitUtilities::test_build_amalgkit_command PASSED [ 21%]
tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitUtilities::test_check_cli_available PASSED [ 22%]
tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitUtilities::test_ensure_cli_available FAILED [ 23%]
tests/test_rna_amalgkit.py::test_build_cli_args_transforms_types PASSED  [ 23%]
tests/test_rna_amalgkit.py::test_build_amalgkit_command_prefix_and_order PASSED [ 24%]
tests/test_rna_amalgkit.py::test_check_cli_available_runs_help SKIPPED   [ 24%]
tests/test_rna_amalgkit.py::test_curate_summary_counts_from_fixture PASSED [ 25%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitStepRunners::test_step_runners_dict_completeness PASSED [ 26%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitStepRunners::test_all_runners_are_callable PASSED [ 26%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitStepRunners::test_all_runners_have_correct_signature PASSED [ 27%]
tests/test_rna_amalgkit_steps.py::TestMetadataStep::test_metadata_function_exists PASSED [ 27%]
tests/test_rna_amalgkit_steps.py::TestMetadataStep::test_metadata_in_step_runners PASSED [ 28%]
tests/test_rna_amalgkit_steps.py::TestMetadataStep::test_metadata_in_amalgkit_module PASSED [ 29%]
tests/test_rna_amalgkit_steps.py::TestMetadataStep::test_metadata_basic_execution SKIPPED [ 29%]
tests/test_rna_amalgkit_steps.py::TestIntegrateStep::test_integrate_function_exists PASSED [ 30%]
tests/test_rna_amalgkit_steps.py::TestIntegrateStep::test_integrate_in_step_runners PASSED [ 30%]
tests/test_rna_amalgkit_steps.py::TestIntegrateStep::test_integrate_in_amalgkit_module PASSED [ 31%]
tests/test_rna_amalgkit_steps.py::TestIntegrateStep::test_integrate_basic_execution SKIPPED [ 32%]
tests/test_rna_amalgkit_steps.py::TestConfigStep::test_config_function_exists PASSED [ 32%]
tests/test_rna_amalgkit_steps.py::TestConfigStep::test_config_in_step_runners PASSED [ 33%]
tests/test_rna_amalgkit_steps.py::TestConfigStep::test_config_in_amalgkit_module PASSED [ 33%]
tests/test_rna_amalgkit_steps.py::TestConfigStep::test_config_basic_execution SKIPPED [ 34%]
tests/test_rna_amalgkit_steps.py::TestSelectStep::test_select_function_exists PASSED [ 35%]
tests/test_rna_amalgkit_steps.py::TestSelectStep::test_select_in_step_runners PASSED [ 35%]
tests/test_rna_amalgkit_steps.py::TestSelectStep::test_select_in_amalgkit_module PASSED [ 36%]
tests/test_rna_amalgkit_steps.py::TestSelectStep::test_select_basic_execution SKIPPED [ 36%]
tests/test_rna_amalgkit_steps.py::TestGetfastqStep::test_getfastq_function_exists PASSED [ 37%]
tests/test_rna_amalgkit_steps.py::TestGetfastqStep::test_getfastq_in_step_runners PASSED [ 38%]
tests/test_rna_amalgkit_steps.py::TestGetfastqStep::test_getfastq_in_amalgkit_module PASSED [ 38%]
tests/test_rna_amalgkit_steps.py::TestGetfastqStep::test_getfastq_basic_execution SKIPPED [ 39%]
tests/test_rna_amalgkit_steps.py::TestQuantStep::test_quant_function_exists PASSED [ 40%]
tests/test_rna_amalgkit_steps.py::TestQuantStep::test_quant_in_step_runners PASSED [ 40%]
tests/test_rna_amalgkit_steps.py::TestQuantStep::test_quant_in_amalgkit_module PASSED [ 41%]
tests/test_rna_amalgkit_steps.py::TestQuantStep::test_quant_basic_execution SKIPPED [ 41%]
tests/test_rna_amalgkit_steps.py::TestMergeStep::test_merge_function_exists PASSED [ 42%]
tests/test_rna_amalgkit_steps.py::TestMergeStep::test_merge_in_step_runners PASSED [ 43%]
tests/test_rna_amalgkit_steps.py::TestMergeStep::test_merge_in_amalgkit_module PASSED [ 43%]
tests/test_rna_amalgkit_steps.py::TestMergeStep::test_merge_basic_execution SKIPPED [ 44%]
tests/test_rna_amalgkit_steps.py::TestCstmmStep::test_cstmm_function_exists PASSED [ 44%]
tests/test_rna_amalgkit_steps.py::TestCstmmStep::test_cstmm_in_step_runners PASSED [ 45%]
tests/test_rna_amalgkit_steps.py::TestCstmmStep::test_cstmm_in_amalgkit_module PASSED [ 46%]
tests/test_rna_amalgkit_steps.py::TestCstmmStep::test_cstmm_basic_execution SKIPPED [ 46%]
tests/test_rna_amalgkit_steps.py::TestCurateStep::test_curate_function_exists PASSED [ 47%]
tests/test_rna_amalgkit_steps.py::TestCurateStep::test_curate_in_step_runners PASSED [ 47%]
tests/test_rna_amalgkit_steps.py::TestCurateStep::test_curate_in_amalgkit_module PASSED [ 48%]
tests/test_rna_amalgkit_steps.py::TestCurateStep::test_curate_basic_execution SKIPPED [ 49%]
tests/test_rna_amalgkit_steps.py::TestCscaStep::test_csca_function_exists PASSED [ 49%]
tests/test_rna_amalgkit_steps.py::TestCscaStep::test_csca_in_step_runners PASSED [ 50%]
tests/test_rna_amalgkit_steps.py::TestCscaStep::test_csca_in_amalgkit_module PASSED [ 50%]
tests/test_rna_amalgkit_steps.py::TestCscaStep::test_csca_basic_execution SKIPPED [ 51%]
tests/test_rna_amalgkit_steps.py::TestSanityStep::test_sanity_function_exists PASSED [ 52%]
tests/test_rna_amalgkit_steps.py::TestSanityStep::test_sanity_in_step_runners PASSED [ 52%]
tests/test_rna_amalgkit_steps.py::TestSanityStep::test_sanity_in_amalgkit_module PASSED [ 53%]
tests/test_rna_amalgkit_steps.py::TestSanityStep::test_sanity_basic_execution SKIPPED [ 53%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitCoreUtilities::test_build_cli_args_exists PASSED [ 54%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitCoreUtilities::test_build_amalgkit_command_exists PASSED [ 55%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitCoreUtilities::test_check_cli_available_exists PASSED [ 55%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitCoreUtilities::test_ensure_cli_available_exists PASSED [ 56%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitCoreUtilities::test_run_amalgkit_exists PASSED [ 56%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitCoreUtilities::test_check_cli_available_returns_tuple PASSED [ 57%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitCoreUtilities::test_build_cli_args_with_none_params PASSED [ 58%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitCoreUtilities::test_build_cli_args_with_empty_params PASSED [ 58%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitCoreUtilities::test_build_cli_args_filters_none_values PASSED [ 59%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitCoreUtilities::test_build_cli_args_handles_boolean_flags PASSED [ 60%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitCoreUtilities::test_build_cli_args_handles_list_values PASSED [ 60%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitCoreUtilities::test_build_cli_args_handles_path_values PASSED [ 61%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitCoreUtilities::test_build_amalgkit_command_structure PASSED [ 61%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitCoreUtilities::test_ensure_cli_available_no_auto_install PASSED [ 62%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitParameterNormalization::test_key_normalization_underscores PASSED [ 63%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitParameterNormalization::test_key_normalization_hyphens PASSED [ 63%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitParameterNormalization::test_bool_value_flags PASSED [ 64%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitExports::test_all_exports_present PASSED [ 64%]
tests/test_rna_amalgkit_steps.py::TestAmalgkitExports::test_amalgkit_params_type_exists PASSED [ 65%]
tests/test_rna_amalgkit_steps.py::TestStepRunnerParameterPassing::test_metadata_passes_work_dir PASSED [ 66%]
tests/test_rna_amalgkit_steps.py::TestStepRunnerParameterPassing::test_all_runners_accept_standard_params PASSED [ 66%]
tests/test_rna_amalgkit_steps.py::TestDocumentationCompleteness::test_all_step_runners_have_docstrings PASSED [ 67%]
tests/test_rna_amalgkit_steps.py::TestDocumentationCompleteness::test_amalgkit_core_functions_have_docstrings PASSED [ 67%]
tests/test_rna_amalgkit_steps.py::TestDocumentationCompleteness::test_amalgkit_subcommand_wrappers_have_docstrings PASSED [ 68%]
tests/test_rna_cli.py::test_rna_plan_cli_lists_expected_steps PASSED     [ 69%]
tests/test_rna_cli.py::test_rna_plan_species_cli_includes_species_and_tissue PASSED [ 69%]
tests/test_rna_config_load_plan.py::test_load_workflow_config_and_plan_uses_yaml_values PASSED [ 70%]
tests/test_rna_config_load_plan.py::test_env_overrides_for_config_threads PASSED [ 70%]
tests/test_rna_configs.py::test_build_step_params_includes_species_tissues_and_layout PASSED [ 71%]
tests/test_rna_configs.py::test_plan_workflow_with_params_merges_common_and_specific PASSED [ 72%]
tests/test_rna_ena_workflow.py::TestENADownloader::test_downloader_script_exists PASSED [ 72%]
tests/test_rna_ena_workflow.py::TestENADownloader::test_downloader_help PASSED [ 73%]
tests/test_rna_ena_workflow.py::TestIntegratedWorkflow::test_workflow_script_exists PASSED [ 73%]
tests/test_rna_ena_workflow.py::TestIntegratedWorkflow::test_workflow_help PASSED [ 74%]
tests/test_rna_ena_workflow.py::TestIntegratedWorkflow::test_workflow_requires_config PASSED [ 75%]
tests/test_rna_ena_workflow.py::TestWorkflowIntegration::test_cfloridanus_config_exists PASSED [ 75%]
tests/test_rna_ena_workflow.py::TestWorkflowIntegration::test_cfloridanus_metadata_exists SKIPPED [ 76%]
tests/test_rna_ena_workflow.py::TestWorkflowIntegration::test_kallisto_index_exists SKIPPED [ 76%]
tests/test_rna_ena_workflow.py::TestWorkflowIntegration::test_quantification_results_exist SKIPPED [ 77%]
tests/test_rna_ena_workflow.py::TestWorkflowDocumentation::test_scripts_readme_mentions_ena_workflow PASSED [ 78%]
tests/test_rna_ena_workflow.py::TestWorkflowDocumentation::test_scripts_agents_mentions_ena PASSED [ 78%]
tests/test_rna_ena_workflow.py::TestWorkflowDocumentation::test_docs_rna_readme_mentions_ena PASSED [ 79%]
tests/test_rna_ena_workflow.py::TestDependencies::test_wget_available PASSED [ 80%]
tests/test_rna_ena_workflow.py::TestDependencies::test_kallisto_available PASSED [ 80%]
tests/test_rna_ena_workflow.py::TestDependencies::test_wget_supports_continue PASSED [ 81%]
tests/test_rna_manifest.py::test_manifest_written_and_logs_directory PASSED [ 81%]
tests/test_rna_orchestrators.py::test_workflow_ena_integrated_has_config_block PASSED [ 82%]
tests/test_rna_orchestrators.py::test_run_multi_species_has_config_block PASSED [ 83%]
tests/test_rna_orchestrators.py::test_batch_download_species_has_config_block PASSED [ 83%]
tests/test_rna_orchestrators.py::test_workflow_ena_integrated_methods_have_docstrings PASSED [ 84%]
tests/test_rna_orchestrators.py::test_run_multi_species_methods_have_docstrings PASSED [ 84%]
tests/test_rna_orchestrators.py::test_batch_download_species_methods_have_docstrings PASSED [ 85%]
tests/test_rna_orchestrators.py::test_orchestrators_import_metainformant_modules PASSED [ 86%]
tests/test_rna_orchestrators.py::test_orchestrators_have_main_guards PASSED [ 86%]
tests/test_rna_orchestrators.py::test_config_blocks_have_required_fields PASSED [ 87%]
tests/test_rna_pipeline.py::TestRNAPipelineConfig::test_config_creation PASSED [ 87%]
tests/test_rna_pipeline.py::TestRNAPipelineConfig::test_config_work_dir_path PASSED [ 88%]
tests/test_rna_pipeline.py::TestSummarizeCurateTables::test_summarize_empty_directory PASSED [ 89%]
tests/test_rna_pipeline.py::TestSummarizeCurateTables::test_summarize_nonexistent_directory PASSED [ 89%]
tests/test_rna_pipeline.py::TestSummarizeCurateTables::test_summarize_with_tsv_files PASSED [ 90%]
tests/test_rna_pipeline.py::TestSummarizeCurateTables::test_summarize_ignores_non_tsv PASSED [ 90%]
tests/test_rna_preflight_manifest.py::test_preflight_manifest_when_amalgkit_missing PASSED [ 91%]
tests/test_rna_run_amalgkit_logging.py::test_run_amalgkit_writes_logs SKIPPED [ 92%]
tests/test_rna_run_config_cli.py::test_cli_run_config_smoke_real_amalgkit SKIPPED [ 92%]
tests/test_rna_run_config_cli.py::test_cli_run_config_offline_behavior PASSED [ 93%]
tests/test_rna_step_runners_dispatch.py::test_each_step_runner_invokes_real_subcommand_or_skips SKIPPED [ 93%]
tests/test_rna_steps_comprehensive.py::TestSequentialProcessing::test_sequential_process_metadata_handling PASSED [ 94%]
tests/test_rna_steps_comprehensive.py::TestSequentialProcessing::test_sequential_process_params PASSED [ 95%]
tests/test_rna_steps_comprehensive.py::TestBatchedProcessing::test_batched_process_metadata_handling PASSED [ 95%]
tests/test_rna_steps_comprehensive.py::TestBatchedProcessing::test_batched_process_params PASSED [ 96%]
tests/test_rna_steps_comprehensive.py::TestStepModuleImports::test_step_modules_importable PASSED [ 96%]
tests/test_rna_steps_comprehensive.py::TestStepModuleImports::test_step_runner_functions_exist PASSED [ 97%]
tests/test_rna_workflow_config.py::test_load_workflow_config_yaml PASSED [ 98%]
tests/test_rna_workflow_deps.py::test_workflow_skips_steps_when_missing_deps SKIPPED [ 98%]
tests/test_rna_workflow_manifest.py::test_manifest_written_with_records SKIPPED [ 99%]
tests/test_rna_workflow.py::test_plan_workflow_orders_steps_and_inherits_common_params PASSED [100%]

=================================== FAILURES ===================================
____________ TestAmalgkitEndToEnd.test_metadata_to_config_workflow _____________

self = <test_rna_amalgkit_end_to_end.TestAmalgkitEndToEnd object at 0x7fc15ecee910>

    def test_metadata_to_config_workflow(self):
        """Test metadata → integrate → config workflow."""
        work_dir = self.test_dir / "workflow1"
        work_dir.mkdir(parents=True, exist_ok=True)
    
        # Step 1: metadata (requires search_string)
        metadata_params = {
            "out_dir": str(work_dir),
            "search_string": "Drosophila melanogaster[Organism] AND brain[tissue]",
            "max_samples": 5,
        }
    
>       result = amalgkit.metadata(
            metadata_params,
            work_dir=str(work_dir),
            log_dir=str(work_dir / "logs"),
            check=False
        )

tests/test_rna_amalgkit_end_to_end.py:40: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/metainformant/rna/amalgkit.py:393: in metadata
    return run_amalgkit("metadata", params, **kwargs)
src/metainformant/rna/amalgkit.py:365: in run_amalgkit
    result = subprocess.run(
/usr/lib/python3.11/subprocess.py:548: in run
    with Popen(*popenargs, **kwargs) as process:
/usr/lib/python3.11/subprocess.py:1024: in __init__
    self._execute_child(args, executable, preexec_fn, close_fds,
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Popen: returncode: 255 args: ['amalgkit', 'metadata', '--out_dir', '/media/...>
args = ['amalgkit', 'metadata', '--out_dir', '/media/q/ext6/github/MetaInformAnt/output/test_amalgkit_e2e/workflow1', '--search_string', 'Drosophila melanogaster[Organism] AND brain[tissue]', ...]
executable = b'amalgkit', preexec_fn = None, close_fds = True, pass_fds = ()
cwd = None
env = {'APPDIR': '/tmp/.mount_Cursor9VZuxv', 'APPIMAGE': '/home/q/Downloads/Cursor-2.0.43-x86_64.AppImage', 'ARGV0': './Cursor-2.0.43-x86_64.AppImage', 'CHROME_DESKTOP': 'cursor.desktop', ...}
startupinfo = None, creationflags = 0, shell = False, p2cread = -1
p2cwrite = -1, c2pread = 13, c2pwrite = 14, errread = 15, errwrite = 16
restore_signals = True, gid = None, gids = None, uid = None, umask = -1
start_new_session = False, process_group = -1

    def _execute_child(self, args, executable, preexec_fn, close_fds,
                       pass_fds, cwd, env,
                       startupinfo, creationflags, shell,
                       p2cread, p2cwrite,
                       c2pread, c2pwrite,
                       errread, errwrite,
                       restore_signals,
                       gid, gids, uid, umask,
                       start_new_session, process_group):
        """Execute program (POSIX version)"""
    
        if isinstance(args, (str, bytes)):
            args = [args]
        elif isinstance(args, os.PathLike):
            if shell:
                raise TypeError('path-like args is not allowed when '
                                'shell is true')
            args = [args]
        else:
            args = list(args)
    
        if shell:
            # On Android the default shell is at '/system/bin/sh'.
            unix_shell = ('/system/bin/sh' if
                      hasattr(sys, 'getandroidapilevel') else '/bin/sh')
            args = [unix_shell, "-c"] + args
            if executable:
                args[0] = executable
    
        if executable is None:
            executable = args[0]
    
        sys.audit("subprocess.Popen", executable, args, cwd, env)
    
        if (_USE_POSIX_SPAWN
                and os.path.dirname(executable)
                and preexec_fn is None
                and not close_fds
                and not pass_fds
                and cwd is None
                and (p2cread == -1 or p2cread > 2)
                and (c2pwrite == -1 or c2pwrite > 2)
                and (errwrite == -1 or errwrite > 2)
                and not start_new_session
                and process_group == -1
                and gid is None
                and gids is None
                and uid is None
                and umask < 0):
            self._posix_spawn(args, executable, env, restore_signals,
                              p2cread, p2cwrite,
                              c2pread, c2pwrite,
                              errread, errwrite)
            return
    
        orig_executable = executable
    
        # For transferring possible exec failure from child to parent.
        # Data format: "exception name:hex errno:description"
        # Pickle is not used; it is complex and involves memory allocation.
        errpipe_read, errpipe_write = os.pipe()
        # errpipe_write must not be in the standard io 0, 1, or 2 fd range.
        low_fds_to_close = []
        while errpipe_write < 3:
            low_fds_to_close.append(errpipe_write)
            errpipe_write = os.dup(errpipe_write)
        for low_fd in low_fds_to_close:
            os.close(low_fd)
        try:
            try:
                # We must avoid complex work that could involve
                # malloc or free in the child process to avoid
                # potential deadlocks, thus we do all this here.
                # and pass it to fork_exec()
    
                if env is not None:
                    env_list = []
                    for k, v in env.items():
                        k = os.fsencode(k)
                        if b'=' in k:
                            raise ValueError("illegal environment variable name")
                        env_list.append(k + b'=' + os.fsencode(v))
                else:
                    env_list = None  # Use execv instead of execve.
                executable = os.fsencode(executable)
                if os.path.dirname(executable):
                    executable_list = (executable,)
                else:
                    # This matches the behavior of os._execvpe().
                    executable_list = tuple(
                        os.path.join(os.fsencode(dir), executable)
                        for dir in os.get_exec_path(env))
                fds_to_keep = set(pass_fds)
                fds_to_keep.add(errpipe_write)
                self.pid = _fork_exec(
                        args, executable_list,
                        close_fds, tuple(sorted(map(int, fds_to_keep))),
                        cwd, env_list,
                        p2cread, p2cwrite, c2pread, c2pwrite,
                        errread, errwrite,
                        errpipe_read, errpipe_write,
                        restore_signals, start_new_session,
                        process_group, gid, gids, uid, umask,
                        preexec_fn, _USE_VFORK)
                self._child_created = True
            finally:
                # be sure the FD is closed no matter what
                os.close(errpipe_write)
    
            self._close_pipe_fds(p2cread, p2cwrite,
                                 c2pread, c2pwrite,
                                 errread, errwrite)
    
            # Wait for exec to fail or succeed; possibly raising an
            # exception (limited in size)
            errpipe_data = bytearray()
            while True:
                part = os.read(errpipe_read, 50000)
                errpipe_data += part
                if not part or len(errpipe_data) > 50000:
                    break
        finally:
            # be sure the FD is closed no matter what
            os.close(errpipe_read)
    
        if errpipe_data:
            try:
                pid, sts = os.waitpid(self.pid, 0)
                if pid == self.pid:
                    self._handle_exitstatus(sts)
                else:
                    self.returncode = sys.maxsize
            except ChildProcessError:
                pass
    
            try:
                exception_name, hex_errno, err_msg = (
                        errpipe_data.split(b':', 2))
                # The encoding here should match the encoding
                # written in by the subprocess implementations
                # like _posixsubprocess
                err_msg = err_msg.decode()
            except ValueError:
                exception_name = b'SubprocessError'
                hex_errno = b'0'
                err_msg = 'Bad exception data from child: {!r}'.format(
                              bytes(errpipe_data))
            child_exception_type = getattr(
                    builtins, exception_name.decode('ascii'),
                    SubprocessError)
            if issubclass(child_exception_type, OSError) and hex_errno:
                errno_num = int(hex_errno, 16)
                child_exec_never_called = (err_msg == "noexec")
                if child_exec_never_called:
                    err_msg = ""
                    # The error must be from chdir(cwd).
                    err_filename = cwd
                else:
                    err_filename = orig_executable
                if errno_num != 0:
                    err_msg = os.strerror(errno_num)
>               raise child_exception_type(errno_num, err_msg, err_filename)
E               FileNotFoundError: [Errno 2] No such file or directory: 'amalgkit'

/usr/lib/python3.11/subprocess.py:1901: FileNotFoundError
----------------------------- Captured stdout call -----------------------------
[18:54:38] starting step 'metadata' -> amalgkit metadata --out_dir /media/q/ext6/github/MetaInformAnt/output/test_amalgkit_e2e/workflow1 --search_string Drosophila melanogaster[Organism] AND brain[tissue] --max_samples 5
_______________ TestAmalgkitEndToEnd.test_workflow_step_sequence _______________

self = <test_rna_amalgkit_end_to_end.TestAmalgkitEndToEnd object at 0x7fc15ecee1d0>

    def test_workflow_step_sequence(self):
        """Test that workflow steps execute in correct sequence."""
        work_dir = self.test_dir / "sequence_test"
        work_dir.mkdir(parents=True, exist_ok=True)
    
        steps_to_test = [
            ("metadata", {"species": ["Apis_mellifera"], "max_samples": 3}),
            ("config", {}),
        ]
    
        for step_name, params in steps_to_test:
            params["out_dir"] = str(work_dir)
    
            step_func = getattr(amalgkit, step_name)
>           result = step_func(
                params,
                work_dir=str(work_dir),
                log_dir=str(work_dir / "logs"),
                check=False
            )

tests/test_rna_amalgkit_end_to_end.py:105: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
src/metainformant/rna/amalgkit.py:393: in metadata
    return run_amalgkit("metadata", params, **kwargs)
src/metainformant/rna/amalgkit.py:365: in run_amalgkit
    result = subprocess.run(
/usr/lib/python3.11/subprocess.py:548: in run
    with Popen(*popenargs, **kwargs) as process:
/usr/lib/python3.11/subprocess.py:1024: in __init__
    self._execute_child(args, executable, preexec_fn, close_fds,
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Popen: returncode: 255 args: ['amalgkit', 'metadata', '--species', 'Apis_me...>
args = ['amalgkit', 'metadata', '--species', 'Apis_mellifera', '--max_samples', '3', ...]
executable = b'amalgkit', preexec_fn = None, close_fds = True, pass_fds = ()
cwd = None
env = {'APPDIR': '/tmp/.mount_Cursor9VZuxv', 'APPIMAGE': '/home/q/Downloads/Cursor-2.0.43-x86_64.AppImage', 'ARGV0': './Cursor-2.0.43-x86_64.AppImage', 'CHROME_DESKTOP': 'cursor.desktop', ...}
startupinfo = None, creationflags = 0, shell = False, p2cread = -1
p2cwrite = -1, c2pread = 13, c2pwrite = 14, errread = 15, errwrite = 16
restore_signals = True, gid = None, gids = None, uid = None, umask = -1
start_new_session = False, process_group = -1

    def _execute_child(self, args, executable, preexec_fn, close_fds,
                       pass_fds, cwd, env,
                       startupinfo, creationflags, shell,
                       p2cread, p2cwrite,
                       c2pread, c2pwrite,
                       errread, errwrite,
                       restore_signals,
                       gid, gids, uid, umask,
                       start_new_session, process_group):
        """Execute program (POSIX version)"""
    
        if isinstance(args, (str, bytes)):
            args = [args]
        elif isinstance(args, os.PathLike):
            if shell:
                raise TypeError('path-like args is not allowed when '
                                'shell is true')
            args = [args]
        else:
            args = list(args)
    
        if shell:
            # On Android the default shell is at '/system/bin/sh'.
            unix_shell = ('/system/bin/sh' if
                      hasattr(sys, 'getandroidapilevel') else '/bin/sh')
            args = [unix_shell, "-c"] + args
            if executable:
                args[0] = executable
    
        if executable is None:
            executable = args[0]
    
        sys.audit("subprocess.Popen", executable, args, cwd, env)
    
        if (_USE_POSIX_SPAWN
                and os.path.dirname(executable)
                and preexec_fn is None
                and not close_fds
                and not pass_fds
                and cwd is None
                and (p2cread == -1 or p2cread > 2)
                and (c2pwrite == -1 or c2pwrite > 2)
                and (errwrite == -1 or errwrite > 2)
                and not start_new_session
                and process_group == -1
                and gid is None
                and gids is None
                and uid is None
                and umask < 0):
            self._posix_spawn(args, executable, env, restore_signals,
                              p2cread, p2cwrite,
                              c2pread, c2pwrite,
                              errread, errwrite)
            return
    
        orig_executable = executable
    
        # For transferring possible exec failure from child to parent.
        # Data format: "exception name:hex errno:description"
        # Pickle is not used; it is complex and involves memory allocation.
        errpipe_read, errpipe_write = os.pipe()
        # errpipe_write must not be in the standard io 0, 1, or 2 fd range.
        low_fds_to_close = []
        while errpipe_write < 3:
            low_fds_to_close.append(errpipe_write)
            errpipe_write = os.dup(errpipe_write)
        for low_fd in low_fds_to_close:
            os.close(low_fd)
        try:
            try:
                # We must avoid complex work that could involve
                # malloc or free in the child process to avoid
                # potential deadlocks, thus we do all this here.
                # and pass it to fork_exec()
    
                if env is not None:
                    env_list = []
                    for k, v in env.items():
                        k = os.fsencode(k)
                        if b'=' in k:
                            raise ValueError("illegal environment variable name")
                        env_list.append(k + b'=' + os.fsencode(v))
                else:
                    env_list = None  # Use execv instead of execve.
                executable = os.fsencode(executable)
                if os.path.dirname(executable):
                    executable_list = (executable,)
                else:
                    # This matches the behavior of os._execvpe().
                    executable_list = tuple(
                        os.path.join(os.fsencode(dir), executable)
                        for dir in os.get_exec_path(env))
                fds_to_keep = set(pass_fds)
                fds_to_keep.add(errpipe_write)
                self.pid = _fork_exec(
                        args, executable_list,
                        close_fds, tuple(sorted(map(int, fds_to_keep))),
                        cwd, env_list,
                        p2cread, p2cwrite, c2pread, c2pwrite,
                        errread, errwrite,
                        errpipe_read, errpipe_write,
                        restore_signals, start_new_session,
                        process_group, gid, gids, uid, umask,
                        preexec_fn, _USE_VFORK)
                self._child_created = True
            finally:
                # be sure the FD is closed no matter what
                os.close(errpipe_write)
    
            self._close_pipe_fds(p2cread, p2cwrite,
                                 c2pread, c2pwrite,
                                 errread, errwrite)
    
            # Wait for exec to fail or succeed; possibly raising an
            # exception (limited in size)
            errpipe_data = bytearray()
            while True:
                part = os.read(errpipe_read, 50000)
                errpipe_data += part
                if not part or len(errpipe_data) > 50000:
                    break
        finally:
            # be sure the FD is closed no matter what
            os.close(errpipe_read)
    
        if errpipe_data:
            try:
                pid, sts = os.waitpid(self.pid, 0)
                if pid == self.pid:
                    self._handle_exitstatus(sts)
                else:
                    self.returncode = sys.maxsize
            except ChildProcessError:
                pass
    
            try:
                exception_name, hex_errno, err_msg = (
                        errpipe_data.split(b':', 2))
                # The encoding here should match the encoding
                # written in by the subprocess implementations
                # like _posixsubprocess
                err_msg = err_msg.decode()
            except ValueError:
                exception_name = b'SubprocessError'
                hex_errno = b'0'
                err_msg = 'Bad exception data from child: {!r}'.format(
                              bytes(errpipe_data))
            child_exception_type = getattr(
                    builtins, exception_name.decode('ascii'),
                    SubprocessError)
            if issubclass(child_exception_type, OSError) and hex_errno:
                errno_num = int(hex_errno, 16)
                child_exec_never_called = (err_msg == "noexec")
                if child_exec_never_called:
                    err_msg = ""
                    # The error must be from chdir(cwd).
                    err_filename = cwd
                else:
                    err_filename = orig_executable
                if errno_num != 0:
                    err_msg = os.strerror(errno_num)
>               raise child_exception_type(errno_num, err_msg, err_filename)
E               FileNotFoundError: [Errno 2] No such file or directory: 'amalgkit'

/usr/lib/python3.11/subprocess.py:1901: FileNotFoundError
----------------------------- Captured stdout call -----------------------------
[18:54:38] starting step 'metadata' -> amalgkit metadata --species Apis_mellifera --max_samples 3 --out_dir /media/q/ext6/github/MetaInformAnt/output/test_amalgkit_e2e/sequence_test
_______________ TestAmalgkitUtilities.test_ensure_cli_available ________________

self = <test_rna_amalgkit_end_to_end.TestAmalgkitUtilities object at 0x7fc15f953910>

    def test_ensure_cli_available(self):
        """Test CLI availability assertion."""
        available, _ = amalgkit.check_cli_available()
        if not available:
>           with pytest.raises(RuntimeError, match="amalgkit.*not available"):
E           Failed: DID NOT RAISE <class 'RuntimeError'>

tests/test_rna_amalgkit_end_to_end.py:330: Failed
=========================== short test summary info ============================
FAILED tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitEndToEnd::test_metadata_to_config_workflow
FAILED tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitEndToEnd::test_workflow_step_sequence
FAILED tests/test_rna_amalgkit_end_to_end.py::TestAmalgkitUtilities::test_ensure_cli_available
================== 3 failed, 136 passed, 26 skipped in 1.81s ===================
