# RNA Workflow Orchestration

## Overview

The RNA module provides comprehensive workflow orchestration for RNA-seq analysis, from raw sequencing data to expression quantification. Workflows are built on the `BaseWorkflowOrchestrator` foundation and integrate with amalgkit for production-ready analysis.

## Architecture

```mermaid
flowchart TB
    subgraph "RNA Orchestration"
        CLI[CLI Interface<br/>metainformant rna] --> Scripts[Script Orchestrators<br/>scripts/rna/run_*.py]
        Scripts --> Workflow[execute_amalgkit_workflow<br/>rna.workflow]
        Workflow --> Steps[Step Functions<br/>rna.steps.run_*]
    end

    subgraph "Workflow Components"
        Config[AmalgkitWorkflowConfig<br/>Configuration]
        Monitoring[Monitoring<br/>rna.monitoring]
        Genome[Genome Prep<br/>rna.genome_prep]
        Steps
    end

    Workflow --> Config
    Workflow --> Monitoring
    Workflow --> Genome
    Steps --> Amalgkit[Amalgkit CLI<br/>External Tool]
```

## Workflow Types

### Complete Amalgkit Workflow

The main workflow orchestrates all 11 amalgkit steps for single-species analysis:

```python
from metainformant.rna.workflow import execute_amalgkit_workflow, AmalgkitWorkflowConfig

# Configure workflow
config = AmalgkitWorkflowConfig(
    work_dir=Path("output/rna/species"),
    species_list=["Apis_mellifera"],
    threads=12
)

# Execute complete workflow
results = execute_amalgkit_workflow(config)

if results["status"] == "completed":
    print(f"Workflow completed in {results['duration_seconds']:.1f}s")
    print(f"Quantified {len(results['steps'])} steps")
else:
    print(f"Workflow failed: {results['errors']}")
```

### Convenience Functions

Simple function-based workflows for common operations:

```python
from metainformant.rna.workflow import run_sequence_simulation_workflow

# Simple sequence simulation
results = run_sequence_simulation_workflow(
    output_dir="output/rna/simulated",
    n_sequences=1000,
    sequence_length=100,
    seed=42
)
```

## Configuration

### AmalgkitWorkflowConfig

Complete configuration for amalgkit workflows:

```python
@dataclass
class AmalgkitWorkflowConfig:
    """Configuration for amalgkit RNA-seq workflow execution."""

    work_dir: Path                           # Base working directory
    threads: int = 6                        # Number of threads
    species_list: list[str] = field(default_factory=list)
    log_dir: Path | None = None             # Optional log directory
    manifest_path: Path | None = None       # Workflow manifest
    auto_install_amalgkit: bool = False     # Auto-install amalgkit

    # Advanced configuration
    genome: dict[str, Any] | None = None    # Genome configuration
    filters: dict[str, Any] = field(default_factory=dict)
```

### Config Loading

Load configuration from YAML files with environment variable overrides:

```python
from metainformant.rna.configs import load_workflow_config

# Load from YAML with AK_ environment overrides
config = load_workflow_config("config/amalgkit/amalgkit_species.yaml")
```

## Workflow Steps

The complete amalgkit workflow consists of 11 orchestrated steps:

| Step | Function | Purpose |
|------|----------|---------|
| **metadata** | `run_metadata` | NCBI SRA metadata retrieval |
| **config** | `run_config` | Configuration file generation |
| **select** | `run_select` | Sample selection and filtering |
| **getfastq** | `run_getfastq` | FASTQ file generation from SRA |
| **integrate** | `run_integrate` | Local FASTQ metadata integration |
| **quant** | `run_quant` | Transcript abundance quantification |
| **merge** | `run_merge` | Expression matrix merging |
| **cstmm** | `run_cstmm` | Cross-species TMM normalization |
| **curate** | `run_curate` | Outlier removal and bias correction |
| **csca** | `run_csca` | Cross-species correlation analysis |
| **sanity** | `run_sanity` | Workflow integrity validation |

### Step Execution Pattern

Each step follows the standardized pattern:

```python
def run_metadata(config: AmalgkitParams, **kwargs) -> dict[str, Any]:
    """Execute metadata retrieval step.

    Args:
        config: Step configuration
        **kwargs: Additional parameters

    Returns:
        Standardized result dictionary
    """
    try:
        # Step logic here
        result = execute_amalgkit_step("metadata", config)

        return {
            "status": "completed",
            "output": {"metadata_file": "path/to/metadata.csv"},
            "metadata": {"samples_found": 100}
        }
    except Exception as e:
        return {
            "status": "failed",
            "errors": [str(e)],
            "output": {}
        }
```

## Monitoring and Progress

### Real-time Monitoring

Workflows provide comprehensive monitoring capabilities:

```python
from metainformant.rna.monitoring import analyze_species_status

# Monitor workflow progress
status = analyze_species_status("Apis_mellifera", work_dir="output/amalgkit")

print(f"Status: {status['overall_status']}")
print(f"Samples quantified: {status['quantified_samples']}")
print(f"Active downloads: {status['active_downloads']}")
```

### Progress Tracking

```python
# Initialize progress tracking
from metainformant.rna.monitoring import initialize_progress_tracking

progress = initialize_progress_tracking(
    species="Apis_mellifera",
    expected_samples=100,
    work_dir="output/amalgkit"
)

# Track progress during workflow
progress.update_quantified_sample("SRR123456")
progress.update_completed_step("quant")
```

## Genome Preparation

### Integrated Genome Setup

Workflows can include genome preparation as part of the orchestration:

```python
from metainformant.rna.genome_prep import orchestrate_genome_setup

# Setup genome for species
genome_config = {
    "species": "Apis_mellifera",
    "accession": "GCF_000001405.40",  # Amel_HAv3.1
    "index_type": "kallisto"
}

genome_result = orchestrate_genome_setup(
    work_dir="output/amalgkit/Apis_mellifera/genome",
    genome_config=genome_config,
    threads=8
)
```

### Genome Requirements

Each species requires:
- **Reference genome** (FASTA format)
- **Gene annotation** (GTF/GFF format)
- **Transcriptome index** (kallisto/salmon)
- **Genome index** (for alignment-based quantification)

## Error Handling and Recovery

### Checkpoint-based Recovery

Workflows support resuming from any failed step:

```python
# Workflow automatically detects completed steps and resumes
results = execute_amalgkit_workflow(config)

# Check for recovery information
if "recovery_info" in results:
    print(f"Resumed from step: {results['recovery_info']['last_completed_step']}")
```

### Error Classification

Errors are categorized for appropriate handling:

```python
# Network errors (retry)
if "connection" in str(error).lower():
    # Implement retry logic

# Data errors (manual intervention)
elif "corrupt" in str(error).lower():
    # Log for manual review

# Configuration errors (fail fast)
elif "config" in str(error).lower():
    raise ValueError(f"Configuration error: {error}")
```

## Performance Optimization

### Parallel Processing

Workflows optimize for available resources:

```python
# Automatic thread distribution
config = AmalgkitWorkflowConfig(
    work_dir=Path("output/rna"),
    threads=24,  # Total threads available
    # Workflow distributes threads across steps automatically
)

# Manual thread control per step
config.per_step = {
    "getfastq": {"threads": 12},  # Download heavy
    "quant": {"threads": 24},     # CPU intensive
}
```

### Memory Management

Large dataset handling:

```python
# Streaming processing for large datasets
with io.read_delimited("large_metadata.csv", chunk_size=1000) as reader:
    for chunk in reader:
        process_chunk(chunk)

# Temporary file cleanup
from metainformant.rna.cleanup import cleanup_partial_downloads
cleanup_partial_downloads(work_dir="output/amalgkit", max_age_hours=24)
```

## Integration with Other Modules

### Cross-Module Workflows

RNA workflows integrate with other METAINFORMANT modules:

```python
# RNA + Protein integration
from metainformant.rna.workflow import execute_amalgkit_workflow
from metainformant.protein.workflow import execute_protein_workflow

# Run RNA workflow
rna_results = execute_amalgkit_workflow(rna_config)

# Use RNA results for protein analysis
protein_config.expression_data = rna_results["expression_matrix"]
protein_results = execute_protein_workflow(protein_config)
```

### Data Flow

```mermaid
flowchart LR
    RNA[RNA Workflow] --> Expr[Expression Matrix<br/>rna/output/quant]
    Expr --> Prot[Protein Workflow<br/>protein/input/]
    Expr --> Multi[Multi-Omics<br/>multiomics/input/]

    RNA --> Qual[Quality Control<br/>quality/input/]
    Qual --> RNA

    RNA --> Viz[Visualization<br/>visualization/input/]
```

## Production Deployment

### Script-based Execution

Production workflows use script orchestrators:

```bash
# Complete species workflow
python3 scripts/rna/run_workflow.py \
    --config config/amalgkit/amalgkit_pogonomyrmex_barbatus.yaml

# Check status
python3 scripts/rna/run_workflow.py \
    --config config/amalgkit/amalgkit_pogonomyrmex_barbatus.yaml \
    --status

# Cleanup and retry failed samples
python3 scripts/rna/run_workflow.py \
    --config config/amalgkit/amalgkit_pogonomyrmex_barbatus.yaml \
    --cleanup-unquantified
```

### Batch Processing

Multi-species batch execution:

```bash
# Process multiple species
for species in "Apis_mellifera" "Pogonomyrmex_barbatus"; do
    python3 scripts/rna/run_workflow.py \
        --config "config/amalgkit/amalgkit_${species}.yaml" &
done
wait
```

## Testing and Validation

### Workflow Testing

```python
import pytest
from metainformant.rna.workflow import execute_amalgkit_workflow

def test_workflow_execution(tmp_path):
    """Test complete workflow execution."""
    config = AmalgkitWorkflowConfig(
        work_dir=tmp_path / "workflow",
        species_list=["test_species"],
        threads=1
    )

    # Mock external dependencies for testing
    results = execute_amalgkit_workflow(config, check=True)

    assert results["status"] == "validated"
    assert "config" in results
```

### Integration Testing

```python
def test_end_to_end_workflow(tmp_path):
    """Test complete workflow with real components."""
    # Setup test data
    setup_test_data(tmp_path)

    # Execute workflow
    config = create_test_config(tmp_path)
    results = execute_amalgkit_workflow(config)

    # Validate results
    assert results["status"] == "completed"
    assert_results_structure(results)
    validate_output_files(results)
```

## Best Practices

### Configuration Management

1. **Use YAML configs** for complex workflows
2. **Environment overrides** for deployment-specific settings
3. **Validation** before workflow execution
4. **Version control** of configuration files

### Error Handling

1. **Graceful degradation** for non-critical failures
2. **Detailed logging** for troubleshooting
3. **Checkpoint recovery** for long-running workflows
4. **Resource cleanup** on failure

### Performance

1. **Resource monitoring** during execution
2. **Parallel processing** where appropriate
3. **Memory management** for large datasets
4. **Progress tracking** for user feedback

### Maintenance

1. **Regular updates** of amalgkit and dependencies
2. **Version pinning** for reproducible results
3. **Documentation updates** with workflow changes
4. **Testing** after dependency updates

## Troubleshooting

### Common Issues

**Workflow hangs during download:**
```bash
# Check active downloads
python3 -c "
from metainformant.rna.monitoring import check_active_downloads
print(check_active_downloads('output/amalgkit'))
"

# Kill stuck downloads
pkill -f wget
```

**Memory issues with large datasets:**
```python
# Reduce threads
config = AmalgkitWorkflowConfig(threads=4)  # Instead of 24

# Enable streaming processing
config.stream_processing = True
```

**Genome index issues:**
```bash
# Rebuild genome indices
python3 scripts/rna/setup_genome.py \
    --species Apis_mellifera \
    --rebuild-indices
```

## Related Documentation

- **[RNA Overview](../rna/README.md)** - RNA module overview
- **[Amalgkit Integration](../rna/amalgkit/)** - Amalgkit-specific documentation
- **[Configuration](../rna/config.md)** - Configuration management
- **[Monitoring](../rna/monitoring.md)** - Progress tracking and monitoring
- **[Orchestration Guide](../../ORCHESTRATION.md)** - Overall orchestration paradigm
- **[Core Workflow](../../core/workflow.md)** - BaseWorkflowOrchestrator details