

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Genome Preparation and Kallisto Index Building &mdash; METAINFORMANT 0.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=938c9ccc"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../index.html" class="icon icon-home">
            METAINFORMANT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dna/index.html">DNA: Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">RNA: Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../protein/index.html">Protein: Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gwas/index.html">GWAS (Genome-Wide Association Studies)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../epigenome/index.html">Epigenome: Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../epigenome/index.html#key-components">Key Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../epigenome/index.html#integration-with-genomics">Integration with Genomics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../epigenome/index.html#analysis-workflows">Analysis Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../epigenome/index.html#planned-extensions">Planned Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ontology/index.html">Ontology Module Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../phenotype/index.html">Phenotype: Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ecology/index.html">Ecology: Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ecology/index.html#key-components">Key Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ecology/index.html#analysis-workflows">Analysis Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ecology/index.html#integration-with-other-modules">Integration with Other Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ecology/index.html#planned-extensions">Planned Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../math/index.html">Math: Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ml/index.html">Machine Learning: Biological Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networks/index.html">Networks: Biological Network Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../singlecell/index.html">Single-Cell Genomics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quality/index.html">Quality Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../visualization/index.html">Visualization: Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simulation/index.html">Simulation: Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../life_events/index.html">Life Events Module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../testing.html">Testing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">METAINFORMANT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Genome Preparation and Kallisto Index Building</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/rna/amalgkit/genome_preparation.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="genome-preparation-and-kallisto-index-building">
<h1>Genome Preparation and Kallisto Index Building<a class="headerlink" href="#genome-preparation-and-kallisto-index-building" title="Link to this heading"></a></h1>
<p><strong>Technical API Reference</strong> - Complete function documentation for genome preparation.</p>
<blockquote>
<div><p><strong>For step-by-step user guide</strong>: See <a class="reference internal" href="genome_setup_guide.html"><span class="std std-doc">genome_setup_guide.md</span></a><br />
<strong>For command reference</strong>: See <a class="reference internal" href="commands.html"><span class="std std-doc">commands.md</span></a><br />
<strong>For API functions</strong>: See <a class="reference internal" href="../API.html#genome-preparation-functions"><span class="std std-ref">API Reference</span></a></p>
</div></blockquote>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>This document describes the genome preparation pipeline for RNA-seq quantification workflows. The process automatically downloads genomes, extracts transcriptome FASTA files, and builds kallisto indexes for reproducible transcript abundance estimation.</p>
<p><strong>This is the technical reference</strong> - for user-friendly step-by-step instructions, see <a class="reference internal" href="genome_setup_guide.html"><span class="std std-doc">genome_setup_guide.md</span></a>.</p>
</section>
<section id="pipeline-flow">
<h2>Pipeline Flow<a class="headerlink" href="#pipeline-flow" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1. Download Genome Package
   ↓
2. Extract Transcriptome FASTA
   ↓
3. Prepare FASTA for Kallisto
   ↓
4. Build Kallisto Index (optional)
   ↓
5. Ready for Quantification
</pre></div>
</div>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Link to this heading"></a></h2>
<section id="genome-configuration">
<h3>Genome Configuration<a class="headerlink" href="#genome-configuration" title="Link to this heading"></a></h3>
<p>Each species configuration includes a <code class="docutils literal notranslate"><span class="pre">genome</span></code> section:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">genome</span><span class="p">:</span>
<span class="w">  </span><span class="nt">accession</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GCF_003227725.1</span><span class="w">  </span><span class="c1"># NCBI assembly accession</span>
<span class="w">  </span><span class="nt">assembly_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cflo_v7.5</span>
<span class="w">  </span><span class="nt">dest_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output/amalgkit/camponotus_floridanus/genome</span>
<span class="w">  </span><span class="nt">include</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">genome</span><span class="w">           </span><span class="c1"># Genomic sequences</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gff3</span><span class="w">            </span><span class="c1"># Gene annotations</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rna</span><span class="w">             </span><span class="c1"># RNA sequences (required for kallisto)</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cds</span><span class="w">             </span><span class="c1"># CDS sequences</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">protein</span><span class="w">         </span><span class="c1"># Protein sequences</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">seq-report</span><span class="w">      </span><span class="c1"># Sequence report</span>
<span class="w">  </span><span class="nt">ftp_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/003/227/725/...</span>
</pre></div>
</div>
</section>
<section id="quantification-configuration">
<h3>Quantification Configuration<a class="headerlink" href="#quantification-configuration" title="Link to this heading"></a></h3>
<p>Enable automatic index building:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">steps</span><span class="p">:</span>
<span class="w">  </span><span class="nt">quant</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># CRITICAL: out_dir should be work_dir (not separate quant_dir)</span>
<span class="w">    </span><span class="c1"># This allows quant to find getfastq output in {out_dir}/getfastq/</span>
<span class="w">    </span><span class="nt">out_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output/amalgkit/camponotus_floridanus/work</span>
<span class="w">    </span><span class="nt">build_index</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span><span class="w">  </span><span class="c1"># Automatically build kallisto index</span>
<span class="w">    </span><span class="nt">threads</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">12</span>
</pre></div>
</div>
</section>
</section>
<section id="automatic-workflow-integration">
<h2>Automatic Workflow Integration<a class="headerlink" href="#automatic-workflow-integration" title="Link to this heading"></a></h2>
<p>The genome preparation is automatically integrated into the workflow execution:</p>
<ol class="arabic simple">
<li><p><strong>Genome Download</strong>: Downloads genome package from NCBI using best-effort methods (CLI → API → FTP)</p></li>
<li><p><strong>Transcriptome Extraction</strong>: Finds RNA FASTA in extracted genome directory</p></li>
<li><p><strong>FASTA Preparation</strong>: Copies transcriptome to <code class="docutils literal notranslate"><span class="pre">work_dir/fasta/{Species_Name}_rna.fasta</span></code></p></li>
<li><p><strong>Index Building</strong>: Builds kallisto index if <code class="docutils literal notranslate"><span class="pre">build_index:</span> <span class="pre">yes</span></code> is set</p></li>
</ol>
<section id="workflow-execution">
<h3>Workflow Execution<a class="headerlink" href="#workflow-execution" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">metainformant.rna.workflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_workflow_config</span><span class="p">,</span> <span class="n">execute_workflow</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">load_workflow_config</span><span class="p">(</span><span class="s2">&quot;config/amalgkit/camponotus_floridanus.yaml&quot;</span><span class="p">)</span>
<span class="n">return_codes</span> <span class="o">=</span> <span class="n">execute_workflow</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
<p>The workflow automatically:</p>
<ul class="simple">
<li><p>Downloads genome if not present</p></li>
<li><p>Prepares transcriptome FASTA</p></li>
<li><p>Builds kallisto index (if enabled)</p></li>
<li><p>Sets <code class="docutils literal notranslate"><span class="pre">fasta_dir</span></code> and <code class="docutils literal notranslate"><span class="pre">index_dir</span></code> in quant parameters</p></li>
</ul>
</section>
</section>
<section id="file-structure">
<h2>File Structure<a class="headerlink" href="#file-structure" title="Link to this heading"></a></h2>
<section id="genome-directory">
<h3>Genome Directory<a class="headerlink" href="#genome-directory" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>output/amalgkit/{species}/genome/
├── download_record.json          # Download metadata
├── ncbi_dataset_api.zip          # Downloaded package (optional)
└── ncbi_dataset_api_extracted/   # Extracted files
    └── ncbi_dataset/
        └── data/
            └── {accession}/
                ├── rna.fna       # RNA transcriptome FASTA
                ├── genomic.fna   # Genome sequence
                ├── genomic.gff  # Gene annotations
                └── ...
</pre></div>
</div>
</section>
<section id="work-directory">
<h3>Work Directory<a class="headerlink" href="#work-directory" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>output/amalgkit/{species}/work/
├── fasta/
│   └── {Species_Name}_rna.fasta  # Prepared transcriptome
├── index/
│   └── {Species_Name}_transcripts.idx  # Kallisto index
└── ...
</pre></div>
</div>
</section>
</section>
<section id="manual-genome-preparation">
<h2>Manual Genome Preparation<a class="headerlink" href="#manual-genome-preparation" title="Link to this heading"></a></h2>
<p>You can also prepare genomes manually using the <code class="docutils literal notranslate"><span class="pre">genome_prep</span></code> module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">metainformant.rna.genome_prep</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">prepare_transcriptome_for_kallisto</span><span class="p">,</span>
    <span class="n">build_kallisto_index</span><span class="p">,</span>
    <span class="n">prepare_genome_for_quantification</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">genome_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;output/amalgkit/camponotus_floridanus/genome&quot;</span><span class="p">)</span>
<span class="n">work_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;output/amalgkit/camponotus_floridanus/work&quot;</span><span class="p">)</span>
<span class="n">species_name</span> <span class="o">=</span> <span class="s2">&quot;Camponotus_floridanus&quot;</span>
<span class="n">accession</span> <span class="o">=</span> <span class="s2">&quot;GCF_003227725.1&quot;</span>

<span class="c1"># Option 1: Complete preparation</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">prepare_genome_for_quantification</span><span class="p">(</span>
    <span class="n">genome_dir</span><span class="p">,</span>
    <span class="n">species_name</span><span class="p">,</span>
    <span class="n">work_dir</span><span class="p">,</span>
    <span class="n">accession</span><span class="o">=</span><span class="n">accession</span><span class="p">,</span>
    <span class="n">build_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">kmer_size</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FASTA: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;fasta_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;index_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Option 2: Step-by-step</span>
<span class="n">fasta_path</span> <span class="o">=</span> <span class="n">prepare_transcriptome_for_kallisto</span><span class="p">(</span>
    <span class="n">genome_dir</span><span class="p">,</span>
    <span class="n">species_name</span><span class="p">,</span>
    <span class="n">work_dir</span><span class="p">,</span>
    <span class="n">accession</span><span class="o">=</span><span class="n">accession</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">fasta_path</span><span class="p">:</span>
    <span class="n">index_path</span> <span class="o">=</span> <span class="n">work_dir</span> <span class="o">/</span> <span class="s2">&quot;index&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">species_name</span><span class="si">}</span><span class="s2">_transcripts.idx&quot;</span>
    <span class="n">build_kallisto_index</span><span class="p">(</span><span class="n">fasta_path</span><span class="p">,</span> <span class="n">index_path</span><span class="p">,</span> <span class="n">kmer_size</span><span class="o">=</span><span class="mi">31</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="orchestration-scripts">
<h2>Orchestration Scripts<a class="headerlink" href="#orchestration-scripts" title="Link to this heading"></a></h2>
<p>METAINFORMANT provides thin orchestrator scripts to manage genome setup at scale. These scripts can be run individually or via the master orchestrator.</p>
<section id="verification-script">
<h3>Verification Script<a class="headerlink" href="#verification-script" title="Link to this heading"></a></h3>
<p><strong>Script</strong>: <code class="docutils literal notranslate"><span class="pre">scripts/rna/verify_genomes_and_indexes.py</span></code></p>
<p>Check the status of all species:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check all species</span>
python3<span class="w"> </span>scripts/rna/verify_genomes_and_indexes.py

<span class="c1"># Check specific species</span>
python3<span class="w"> </span>scripts/rna/verify_genomes_and_indexes.py<span class="w"> </span>--species<span class="w"> </span>camponotus_floridanus

<span class="c1"># Custom output location</span>
python3<span class="w"> </span>scripts/rna/verify_genomes_and_indexes.py<span class="w"> </span>--output<span class="w"> </span>output/my_status.json
</pre></div>
</div>
<p><strong>Output</strong>: Detailed status report with percentages and next-step recommendations</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>================================================================================
VERIFICATION SUMMARY
================================================================================
Total species: 24

Genome Downloads:
  ✓ Downloaded: 9/24 (37.5%)
  ✗ Missing: 15/24

RNA FASTA Files (of downloaded genomes):
  ✓ Found: 3/9 (33.3%)
  ✗ Missing: 6/9

Kallisto Indexes (of prepared transcriptomes):
  ✓ Built: 4/3 (133.3%)
  ✗ Missing: 0/3

================================================================================

Next Steps:
  → Download 15 missing genomes:
     python3 scripts/rna/download_missing_genomes.py
  → Prepare 6 transcriptomes:
     python3 scripts/rna/prepare_transcriptomes.py
</pre></div>
</div>
</section>
<section id="download-missing-genomes">
<h3>Download Missing Genomes<a class="headerlink" href="#download-missing-genomes" title="Link to this heading"></a></h3>
<p><strong>Script</strong>: <code class="docutils literal notranslate"><span class="pre">scripts/rna/download_missing_genomes.py</span></code></p>
<p>Download genomes for species that are missing them:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download all missing genomes</span>
python3<span class="w"> </span>scripts/rna/download_missing_genomes.py

<span class="c1"># Download for specific species</span>
python3<span class="w"> </span>scripts/rna/download_missing_genomes.py<span class="w"> </span>--species<span class="w"> </span>camponotus_floridanus

<span class="c1"># Dry run (see what would be downloaded)</span>
python3<span class="w"> </span>scripts/rna/download_missing_genomes.py<span class="w"> </span>--dry-run
</pre></div>
</div>
<p><strong>Features</strong>:</p>
<ul class="simple">
<li><p>Skips already-downloaded genomes</p></li>
<li><p>Uses best-effort download (CLI → API → FTP)</p></li>
<li><p>Logs progress and results</p></li>
<li><p>Writes JSON report with download status</p></li>
</ul>
<p><strong>Output</strong>: <code class="docutils literal notranslate"><span class="pre">output/genome_download_results.json</span></code></p>
</section>
<section id="prepare-transcriptomes">
<h3>Prepare Transcriptomes<a class="headerlink" href="#prepare-transcriptomes" title="Link to this heading"></a></h3>
<p><strong>Script</strong>: <code class="docutils literal notranslate"><span class="pre">scripts/rna/prepare_transcriptomes.py</span></code></p>
<p>Extract and prepare RNA FASTA files for species with downloaded genomes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare all transcriptomes</span>
python3<span class="w"> </span>scripts/rna/prepare_transcriptomes.py

<span class="c1"># Prepare for specific species</span>
python3<span class="w"> </span>scripts/rna/prepare_transcriptomes.py<span class="w"> </span>--species<span class="w"> </span>camponotus_floridanus

<span class="c1"># Dry run</span>
python3<span class="w"> </span>scripts/rna/prepare_transcriptomes.py<span class="w"> </span>--dry-run
</pre></div>
</div>
<p><strong>Features</strong>:</p>
<ul class="simple">
<li><p>Finds RNA FASTA in downloaded genome packages</p></li>
<li><p>Decompresses if needed</p></li>
<li><p>Copies to <code class="docutils literal notranslate"><span class="pre">work_dir/fasta/{Species_Name}_rna.fasta</span></code></p></li>
<li><p>Skips already-prepared transcriptomes</p></li>
</ul>
<p><strong>Output</strong>: <code class="docutils literal notranslate"><span class="pre">output/transcriptome_preparation_results.json</span></code></p>
</section>
<section id="build-kallisto-indexes">
<h3>Build Kallisto Indexes<a class="headerlink" href="#build-kallisto-indexes" title="Link to this heading"></a></h3>
<p><strong>Script</strong>: <code class="docutils literal notranslate"><span class="pre">scripts/rna/build_kallisto_indexes.py</span></code></p>
<p>Build kallisto indexes for species with prepared transcriptomes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build all indexes</span>
python3<span class="w"> </span>scripts/rna/build_kallisto_indexes.py

<span class="c1"># Build for specific species</span>
python3<span class="w"> </span>scripts/rna/build_kallisto_indexes.py<span class="w"> </span>--species<span class="w"> </span>camponotus_floridanus

<span class="c1"># Custom k-mer size (for short reads)</span>
python3<span class="w"> </span>scripts/rna/build_kallisto_indexes.py<span class="w"> </span>--kmer-size<span class="w"> </span><span class="m">23</span>

<span class="c1"># Dry run</span>
python3<span class="w"> </span>scripts/rna/build_kallisto_indexes.py<span class="w"> </span>--dry-run
</pre></div>
</div>
<p><strong>Features</strong>:</p>
<ul class="simple">
<li><p>Requires kallisto on PATH</p></li>
<li><p>Uses k-mer size 31 by default (use 23 for short reads)</p></li>
<li><p>Skips already-built indexes</p></li>
<li><p>Verifies index creation</p></li>
</ul>
<p><strong>Output</strong>: <code class="docutils literal notranslate"><span class="pre">output/kallisto_index_build_results.json</span></code></p>
</section>
<section id="master-orchestrator">
<h3>Master Orchestrator<a class="headerlink" href="#master-orchestrator" title="Link to this heading"></a></h3>
<p><strong>Script</strong>: <code class="docutils literal notranslate"><span class="pre">scripts/rna/orchestrate_genome_setup.py</span></code></p>
<p>Runs the complete pipeline sequentially:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Complete setup for all species</span>
python3<span class="w"> </span>scripts/rna/orchestrate_genome_setup.py

<span class="c1"># Setup for specific species</span>
python3<span class="w"> </span>scripts/rna/orchestrate_genome_setup.py<span class="w"> </span>--species<span class="w"> </span>camponotus_floridanus

<span class="c1"># Skip specific steps</span>
python3<span class="w"> </span>scripts/rna/orchestrate_genome_setup.py<span class="w"> </span>--skip-download<span class="w"> </span>--skip-prepare

<span class="c1"># Dry run</span>
python3<span class="w"> </span>scripts/rna/orchestrate_genome_setup.py<span class="w"> </span>--dry-run
</pre></div>
</div>
<p><strong>Pipeline Steps</strong>:</p>
<ol class="arabic simple">
<li><p>Initial verification (optional: <code class="docutils literal notranslate"><span class="pre">--skip-verify-initial</span></code>)</p></li>
<li><p>Download missing genomes (optional: <code class="docutils literal notranslate"><span class="pre">--skip-download</span></code>)</p></li>
<li><p>Prepare transcriptomes (optional: <code class="docutils literal notranslate"><span class="pre">--skip-prepare</span></code>)</p></li>
<li><p>Build kallisto indexes (optional: <code class="docutils literal notranslate"><span class="pre">--skip-build</span></code>)</p></li>
<li><p>Final verification (optional: <code class="docutils literal notranslate"><span class="pre">--skip-verify-final</span></code>)</p></li>
</ol>
<p><strong>Output Files</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">output/genome_index_status_initial.json</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">output/genome_download_results.json</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">output/transcriptome_preparation_results.json</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">output/kallisto_index_build_results.json</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">output/genome_index_status_final.json</span></code></p></li>
</ul>
</section>
</section>
<section id="verification">
<h2>Verification<a class="headerlink" href="#verification" title="Link to this heading"></a></h2>
<section id="verify-all-species">
<h3>Verify All Species<a class="headerlink" href="#verify-all-species" title="Link to this heading"></a></h3>
<p>Use the verification script to check genome downloads and indexes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3<span class="w"> </span>scripts/rna/verify_genomes_and_indexes.py
</pre></div>
</div>
<p>This will:</p>
<ul class="simple">
<li><p>Scan all config files in <code class="docutils literal notranslate"><span class="pre">config/amalgkit/</span></code></p></li>
<li><p>Check genome download status</p></li>
<li><p>Verify RNA FASTA availability</p></li>
<li><p>Check kallisto index existence</p></li>
<li><p>Generate a summary report with percentages</p></li>
<li><p>Suggest next steps</p></li>
</ul>
</section>
<section id="output">
<h3>Output<a class="headerlink" href="#output" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>================================================================================
VERIFICATION SUMMARY
================================================================================
Total species: 24

Genome Downloads:
  ✓ Downloaded: 9/24 (37.5%)
  ✗ Missing: 15/24

RNA FASTA Files (of downloaded genomes):
  ✓ Found: 3/9 (33.3%)
  ✗ Missing: 6/9

Kallisto Indexes (of prepared transcriptomes):
  ✓ Built: 4/3 (133.3%)
  ✗ Missing: 0/3

================================================================================

Next Steps:
  → Download 15 missing genomes:
     python3 scripts/rna/download_missing_genomes.py
  → Prepare 6 transcriptomes:
     python3 scripts/rna/prepare_transcriptomes.py
</pre></div>
</div>
<p>Results are written to <code class="docutils literal notranslate"><span class="pre">output/genome_index_status.json</span></code> with detailed information for each species.</p>
</section>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading"></a></h2>
<section id="issue-rna-fasta-not-found">
<h3>Issue: RNA FASTA Not Found<a class="headerlink" href="#issue-rna-fasta-not-found" title="Link to this heading"></a></h3>
<p><strong>Symptoms</strong>: <code class="docutils literal notranslate"><span class="pre">rna_fasta_found:</span> <span class="pre">false</span></code> in verification output</p>
<p><strong>Solutions</strong>:</p>
<ol class="arabic">
<li><p>Check if genome download completed successfully:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>output/amalgkit/<span class="o">{</span>species<span class="o">}</span>/genome/download_record.json
</pre></div>
</div>
</li>
<li><p>Verify RNA was included in download:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">genome</span><span class="p">:</span>
<span class="w">  </span><span class="nt">include</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rna</span><span class="w">  </span><span class="c1"># Must be present</span>
</pre></div>
</div>
</li>
<li><p>Manually search for RNA FASTA:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>find<span class="w"> </span>output/amalgkit/<span class="o">{</span>species<span class="o">}</span>/genome<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;rna.fna*&quot;</span><span class="w"> </span>-o<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*rna*.fna*&quot;</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="issue-kallisto-index-not-built">
<h3>Issue: Kallisto Index Not Built<a class="headerlink" href="#issue-kallisto-index-not-built" title="Link to this heading"></a></h3>
<p><strong>Symptoms</strong>: <code class="docutils literal notranslate"><span class="pre">kallisto_index_found:</span> <span class="pre">false</span></code> in verification output</p>
<p><strong>Solutions</strong>:</p>
<ol class="arabic">
<li><p>Ensure <code class="docutils literal notranslate"><span class="pre">build_index:</span> <span class="pre">yes</span></code> in quant config</p></li>
<li><p>Check if kallisto is installed:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>which<span class="w"> </span>kallisto
kallisto<span class="w"> </span>version
</pre></div>
</div>
</li>
<li><p>Manually build index:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">metainformant.rna.genome_prep</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_kallisto_index</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">fasta_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;output/amalgkit/</span><span class="si">{species}</span><span class="s2">/work/fasta/</span><span class="si">{Species}</span><span class="s2">_rna.fasta&quot;</span><span class="p">)</span>
<span class="n">index_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;output/amalgkit/</span><span class="si">{species}</span><span class="s2">/work/index/</span><span class="si">{Species}</span><span class="s2">_transcripts.idx&quot;</span><span class="p">)</span>
<span class="n">build_kallisto_index</span><span class="p">(</span><span class="n">fasta_path</span><span class="p">,</span> <span class="n">index_path</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="issue-wrong-species-name-in-index">
<h3>Issue: Wrong Species Name in Index<a class="headerlink" href="#issue-wrong-species-name-in-index" title="Link to this heading"></a></h3>
<p><strong>Symptoms</strong>: Index exists but has different naming</p>
<p><strong>Cause</strong>: Species name in config doesn’t match index filename pattern</p>
<p><strong>Solution</strong>: Index files must match: <code class="docutils literal notranslate"><span class="pre">{Species_Name}_transcripts.idx</span></code> where spaces are replaced with underscores</p>
</section>
</section>
<section id="best-practices">
<h2>Best Practices<a class="headerlink" href="#best-practices" title="Link to this heading"></a></h2>
<section id="consistent-naming">
<h3>1. Consistent Naming<a class="headerlink" href="#consistent-naming" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Use underscores in species names: <code class="docutils literal notranslate"><span class="pre">Camponotus_floridanus</span></code></p></li>
<li><p>Index files follow pattern: <code class="docutils literal notranslate"><span class="pre">{Species_Name}_transcripts.idx</span></code></p></li>
<li><p>FASTA files follow pattern: <code class="docutils literal notranslate"><span class="pre">{Species_Name}_rna.fasta</span></code></p></li>
</ul>
</section>
<section id="index-building">
<h3>2. Index Building<a class="headerlink" href="#index-building" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Build indexes once per genome version</p></li>
<li><p>Use k-mer size 31 for standard reads (≥100bp)</p></li>
<li><p>Use k-mer size 23 for short reads (&lt;100bp)</p></li>
</ul>
</section>
<section id="id1">
<h3>3. Verification<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Run verification script regularly to track preparation status</p></li>
<li><p>Check verification output before running large quantification jobs</p></li>
<li><p>Document any manual interventions</p></li>
</ul>
</section>
<section id="disk-space">
<h3>4. Disk Space<a class="headerlink" href="#disk-space" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Genome packages can be large (100MB - 1GB+)</p></li>
<li><p>Indexes are typically 20-50MB</p></li>
<li><p>FASTA files are typically 10-100MB</p></li>
<li><p>Consider cleaning up extracted genome packages after index building</p></li>
</ul>
</section>
</section>
<section id="api-reference">
<h2>API Reference<a class="headerlink" href="#api-reference" title="Link to this heading"></a></h2>
<section id="prepare-genome-for-quantification">
<h3><code class="docutils literal notranslate"><span class="pre">prepare_genome_for_quantification()</span></code><a class="headerlink" href="#prepare-genome-for-quantification" title="Link to this heading"></a></h3>
<p>Complete genome preparation pipeline.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">prepare_genome_for_quantification</span><span class="p">(</span>
    <span class="n">genome_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">species_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">work_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">accession</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">build_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">kmer_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>Returns</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">success</span></code>: bool - Whether preparation succeeded</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fasta_path</span></code>: str | None - Path to prepared FASTA</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">index_path</span></code>: str | None - Path to built index</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">error</span></code>: str | None - Error message if failed</p></li>
</ul>
</section>
<section id="prepare-transcriptome-for-kallisto">
<h3><code class="docutils literal notranslate"><span class="pre">prepare_transcriptome_for_kallisto()</span></code><a class="headerlink" href="#prepare-transcriptome-for-kallisto" title="Link to this heading"></a></h3>
<p>Extract and prepare transcriptome FASTA.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">prepare_transcriptome_for_kallisto</span><span class="p">(</span>
    <span class="n">genome_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">species_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">work_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">accession</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span>
</pre></div>
</div>
<p><strong>Returns</strong>: Path to prepared FASTA file or None if failed</p>
</section>
<section id="build-kallisto-index">
<h3><code class="docutils literal notranslate"><span class="pre">build_kallisto_index()</span></code><a class="headerlink" href="#build-kallisto-index" title="Link to this heading"></a></h3>
<p>Build kallisto index from FASTA.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">build_kallisto_index</span><span class="p">(</span>
    <span class="n">fasta_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">index_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">kmer_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
    <span class="n">check_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span>
</pre></div>
</div>
<p><strong>Returns</strong>: True if index was built successfully or already exists</p>
</section>
</section>
<section id="quick-start-guide">
<h2>Quick Start Guide<a class="headerlink" href="#quick-start-guide" title="Link to this heading"></a></h2>
<section id="complete-setup-for-all-species">
<h3>Complete Setup for All Species<a class="headerlink" href="#complete-setup-for-all-species" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Step 1: Check current status</span>
python3<span class="w"> </span>scripts/rna/verify_genomes_and_indexes.py

<span class="c1"># Step 2: Run complete setup (or use master orchestrator)</span>
python3<span class="w"> </span>scripts/rna/orchestrate_genome_setup.py

<span class="c1"># Step 3: Verify final status</span>
python3<span class="w"> </span>scripts/rna/verify_genomes_and_indexes.py
</pre></div>
</div>
</section>
<section id="setup-for-single-species">
<h3>Setup for Single Species<a class="headerlink" href="#setup-for-single-species" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Complete setup for one species</span>
python3<span class="w"> </span>scripts/rna/orchestrate_genome_setup.py<span class="w"> </span>--species<span class="w"> </span>camponotus_floridanus

<span class="c1"># Or step-by-step:</span>
python3<span class="w"> </span>scripts/rna/download_missing_genomes.py<span class="w"> </span>--species<span class="w"> </span>camponotus_floridanus
python3<span class="w"> </span>scripts/rna/prepare_transcriptomes.py<span class="w"> </span>--species<span class="w"> </span>camponotus_floridanus
python3<span class="w"> </span>scripts/rna/build_kallisto_indexes.py<span class="w"> </span>--species<span class="w"> </span>camponotus_floridanus
</pre></div>
</div>
</section>
<section id="incremental-setup">
<h3>Incremental Setup<a class="headerlink" href="#incremental-setup" title="Link to this heading"></a></h3>
<p>If you need to download/prepare/build only missing items:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download missing genomes only</span>
python3<span class="w"> </span>scripts/rna/download_missing_genomes.py

<span class="c1"># Prepare transcriptomes for newly downloaded genomes</span>
python3<span class="w"> </span>scripts/rna/prepare_transcriptomes.py

<span class="c1"># Build indexes for newly prepared transcriptomes</span>
python3<span class="w"> </span>scripts/rna/build_kallisto_indexes.py
</pre></div>
</div>
</section>
</section>
<section id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Link to this heading"></a></h2>
<section id="user-guides">
<h3>User Guides<a class="headerlink" href="#user-guides" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong><a class="reference internal" href="genome_setup_guide.html"><span class="std std-doc">genome_setup_guide.md</span></a></strong> - Step-by-step user guide</p></li>
<li><p><strong><a class="reference internal" href="commands.html"><span class="std std-doc">commands.md</span></a></strong> - Command reference for all scripts</p></li>
</ul>
</section>
<section id="documentation">
<h3>Documentation<a class="headerlink" href="#documentation" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><strong><a class="reference internal" href="../API.html#genome-preparation-functions"><span class="std std-ref">API Reference</span></a></strong> - Complete function documentation</p></li>
<li><p><strong><a class="reference internal" href="FUNCTIONS.html"><span class="std std-doc">Function Index</span></a></strong> - Quick function lookup</p></li>
<li><p><strong><a class="reference internal" href="#steps/quant.md"><span class="xref myst">Quantification Step</span></a></strong> - Using kallisto indexes</p></li>
<li><p><strong><a class="reference internal" href="amalgkit.html"><span class="std std-doc">Pipeline Overview</span></a></strong> - Complete workflow documentation</p></li>
<li><p><strong><a class="reference internal" href="../README.html"><span class="std std-doc">Main Index</span></a></strong> - RNA domain master index</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, METAINFORMANT Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>