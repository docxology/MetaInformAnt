name: Build Package

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - wheel-only
          - sdist-only
          - check-only

env:
  PYTHONUNBUFFERED: 1

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}

    - name: Install build dependencies
      run: |
        uv add --dev build twine
        uv add --dev --group test  # For build validation tests

    - name: Build package
      run: |
        case "${{ github.event.inputs.build_type || 'all' }}" in
          "wheel-only")
            bash scripts/package/build.sh --wheel-only
            ;;
          "sdist-only")
            bash scripts/package/build.sh --sdist-only
            ;;
          "check-only")
            bash scripts/package/build.sh --check
            ;;
          *)
            bash scripts/package/build.sh --check
            ;;
        esac

    - name: Validate package structure
      run: |
        # Check that dist directory was created
        if [ ! -d "dist" ]; then
          echo "ERROR: dist directory not found"
          exit 1
        fi

        # List built artifacts
        echo "Built artifacts:"
        ls -la dist/

        # Check for expected files
        if [ "${{ github.event.inputs.build_type || 'all' }}" != "check-only" ]; then
          # Should have at least one wheel or sdist
          if ! ls dist/*.whl dist/*.tar.gz >/dev/null 2>&1; then
            echo "ERROR: No wheel or sdist files found in dist/"
            exit 1
          fi
        fi

    - name: Test package installation
      run: |
        # Create a temporary virtual environment for testing
        python -m venv test_install
        source test_install/bin/activate

        # Install the built package
        if ls dist/*.whl >/dev/null 2>&1; then
          pip install dist/*.whl
        elif ls dist/*.tar.gz >/dev/null 2>&1; then
          pip install dist/*.tar.gz
        else
          echo "ERROR: No package files to install"
          exit 1
        fi

        # Test basic import
        python -c "import metainformant; print(f'Successfully imported metainformant {metainformant.__version__}')"

        # Test CLI
        metainformant --help > /dev/null

        # Clean up
        deactivate
        rm -rf test_install

    - name: Run build validation tests
      run: |
        # Run our custom build validation tests
        if [ -f "tests/test_build.py" ]; then
          uv run pytest tests/test_build.py -v
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: metainformant-${{ matrix.python-version }}-${{ github.sha }}
        path: |
          dist/
          !dist/**/.git/
        retention-days: 30

  build-validation:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: metainformant-3.12-${{ github.sha }}
        path: dist/

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python 3.12
      run: uv python install 3.12

    - name: Install package and test
      run: |
        # Test installation in clean environment
        python -m venv validation_env
        source validation_env/bin/activate

        # Install from wheel
        if ls dist/*.whl >/dev/null 2>&1; then
          pip install dist/*.whl
        else
          echo "ERROR: No wheel found for validation"
          exit 1
        fi

        # Run comprehensive validation
        python -c "
        import metainformant as mi
        print(f'✓ Import successful: {mi.__version__}')

        # Test core functionality
        from metainformant.core import io
        print('✓ Core IO import successful')

        # Test CLI
        import subprocess
        result = subprocess.run(['metainformant', '--version'], capture_output=True, text=True)
        if result.returncode == 0:
            print('✓ CLI works')
        else:
            print('✗ CLI failed')
            exit(1)
        "

        # Clean up
        deactivate
        rm -rf validation_env

  summary:
    runs-on: ubuntu-latest
    needs: [build, build-validation]
    if: always()
    steps:
    - name: Build Summary
      run: |
        echo "Build Summary:"
        echo "- Build job: ${{ needs.build.result }}"
        echo "- Validation job: ${{ needs.build-validation.result }}"

        if [[ "${{ needs.build.result }}" == "success" ]] && \
           [[ "${{ needs.build-validation.result }}" == "success" ]]; then
          echo "✅ All build checks passed"
        else
          echo "❌ Some build checks failed"
          exit 1
        fi
